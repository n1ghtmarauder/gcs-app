<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GCS | Guinea Cargo Services</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--primary:#1a5f4a;--primary-light:#238b6a;--primary-dark:#0f3d2f;--accent:#e8a838;--danger:#c44536;--danger-light:#f8d7d4;--success:#2e7d5a;--success-light:#d4edda;--bg-dark:#0d1f1a;--bg-main:#f7f9f8;--bg-card:#fff;--text-primary:#1a2e28;--text-secondary:#5a6b65;--text-muted:#8a9a94;--border:#d8e0dc;--border-light:#e8eeeb;--radius-sm:6px;--radius-md:10px;--radius-lg:16px}
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--bg-main);color:var(--text-primary);min-height:100vh}
    .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--bg-dark) 0%,var(--primary-dark) 100%);padding:20px}
    .login-container{background:var(--bg-card);border-radius:var(--radius-lg);width:100%;max-width:420px;overflow:hidden}
    .login-header{background:var(--bg-dark);padding:32px;text-align:center}.login-header h1{font-size:22px;color:#fff;margin-bottom:4px}.login-header h1 span{color:var(--accent)}.login-header p{color:rgba(255,255,255,0.6);font-size:12px;text-transform:uppercase;letter-spacing:1px}
    .login-body{padding:32px}.login-tabs{display:flex;gap:4px;background:var(--bg-main);padding:4px;border-radius:var(--radius-md);margin-bottom:24px}.login-tab{flex:1;padding:10px;border:none;background:transparent;border-radius:var(--radius-sm);font-size:14px;font-weight:600;color:var(--text-secondary);cursor:pointer;font-family:inherit}.login-tab.active{background:var(--bg-card);color:var(--primary)}
    .form-group{margin-bottom:20px}.form-label{display:block;font-size:13px;font-weight:600;margin-bottom:8px}.form-input{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:14px;font-family:inherit}.form-input:focus{outline:none;border-color:var(--primary)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 24px;border-radius:var(--radius-md);font-size:14px;font-weight:600;cursor:pointer;border:none;font-family:inherit;width:100%}.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-light)}.btn-secondary{background:var(--bg-main);color:var(--text-primary);border:1px solid var(--border)}
    .error-message,.success-message{padding:12px;border-radius:var(--radius-md);font-size:13px;margin-bottom:20px;display:none}.error-message{background:var(--danger-light);color:var(--danger)}.success-message{background:var(--success-light);color:var(--success)}.error-message.show,.success-message.show{display:block}
    .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
    .app-container,.docs-screen{display:none}.app-container.show,.docs-screen.show{display:block}.login-screen.hidden{display:none}
    .docs-screen{min-height:100vh;background:var(--bg-main);padding:20px}.docs-container{max-width:800px;margin:0 auto}.docs-header{text-align:center;padding:32px 0;border-bottom:1px solid var(--border);margin-bottom:32px}.docs-header h1{font-size:28px;color:var(--primary);margin-bottom:8px}
    .doc-card{background:var(--bg-card);border-radius:var(--radius-lg);border:1px solid var(--border-light);margin-bottom:20px;overflow:hidden}.doc-card-header{padding:20px 24px;background:var(--bg-main);border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center}.doc-card-header h3{font-size:16px}
    .doc-status{font-size:12px;padding:4px 12px;border-radius:20px;font-weight:600}.doc-status.pending{background:var(--danger-light);color:var(--danger)}.doc-status.signed{background:var(--success-light);color:var(--success)}
    .doc-card-body{padding:24px;max-height:300px;overflow-y:auto;font-size:13px;line-height:1.7;color:var(--text-secondary)}.doc-card-body h4{color:var(--text-primary);margin:16px 0 8px;font-size:14px}.doc-card-body ul{margin-left:20px;margin-bottom:12px}
    .doc-card-footer{padding:16px 24px;background:var(--bg-main);border-top:1px solid var(--border-light);display:flex;gap:12px;align-items:center}
    .signature-input{flex:1;padding:12px 16px;border:2px dashed var(--border);border-radius:var(--radius-md);font-family:'Space Mono',monospace;font-size:16px;text-align:center}.signature-input:focus{outline:none;border-color:var(--primary);border-style:solid}
    .checkbox-group{display:flex;align-items:flex-start;gap:12px}.checkbox-group input{width:20px;height:20px;cursor:pointer}.checkbox-group label{font-size:13px;cursor:pointer}
    .progress-bar{height:8px;background:var(--border);border-radius:4px;margin-bottom:24px;overflow:hidden}.progress-fill{height:100%;background:var(--primary);transition:width 0.3s}.progress-text{font-size:13px;color:var(--text-secondary);margin-bottom:8px}
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:260px;background:var(--bg-dark);padding:24px 0;z-index:100;display:flex;flex-direction:column}.logo{padding:20px 24px 28px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:24px}.logo h1{font-size:20px;color:#fff}.logo h1 span{color:var(--accent)}.logo p{font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px;text-transform:uppercase;letter-spacing:1px}
    .role-badge{display:inline-block;background:var(--accent);color:var(--bg-dark);font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:8px;text-transform:uppercase}
    .nav-section{padding:0 12px}.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;color:rgba(255,255,255,0.7);border-radius:var(--radius-md);cursor:pointer;font-size:14px;margin-bottom:4px}.nav-item:hover{background:rgba(255,255,255,0.08);color:#fff}.nav-item.active{background:var(--primary);color:#fff}.nav-item svg{width:20px;height:20px}.nav-badge{margin-left:auto;background:var(--accent);color:var(--bg-dark);font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px}.admin-only{display:none}
    .sidebar-footer{margin-top:auto;padding:24px;border-top:1px solid rgba(255,255,255,0.1)}.user-info{margin-bottom:16px}.user-info .name{font-size:13px;font-weight:600;color:#fff}.user-info .email{font-size:11px;color:rgba(255,255,255,0.5)}.logout-btn{width:100%;padding:10px;background:rgba(255,255,255,0.1);border:none;border-radius:var(--radius-md);color:rgba(255,255,255,0.7);font-size:13px;cursor:pointer}.logout-btn:hover{background:rgba(255,255,255,0.15);color:#fff}
    .main{margin-left:260px;min-height:100vh}.header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:20px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}.header h2{font-size:22px}.header p{font-size:13px;color:var(--text-secondary);margin-top:2px}.header-actions{display:flex;gap:12px}.content{padding:32px}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px}.stat-card{background:var(--bg-card);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--border-light)}.stat-card.highlight{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none}.stat-card.highlight .stat-label,.stat-card.highlight .stat-value{color:#fff}.stat-label{font-size:13px;color:var(--text-secondary);margin-bottom:8px}.stat-value{font-size:28px;font-weight:700;font-family:'Space Mono',monospace}
    .card{background:var(--bg-card);border-radius:var(--radius-lg);border:1px solid var(--border-light);overflow:hidden;margin-bottom:24px}.card-header{padding:20px 24px;border-bottom:1px solid var(--border-light)}.card-header h3{font-size:16px}
    table{width:100%;border-collapse:collapse}th{text-align:left;padding:14px 16px;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);background:var(--bg-main);border-bottom:1px solid var(--border)}td{padding:16px;font-size:14px;border-bottom:1px solid var(--border-light)}tr:hover{background:var(--bg-main)}
    .customer-cell{display:flex;align-items:center;gap:12px}.customer-avatar{width:36px;height:36px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:13px}.customer-info .name{font-weight:600}.customer-info .id{font-size:12px;color:var(--text-muted);font-family:'Space Mono',monospace}
    .status-badge{display:inline-flex;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600}.status-badge.received{background:var(--success-light);color:var(--success)}.weight-cell{font-family:'Space Mono',monospace;font-weight:600}.value-cell{font-family:'Space Mono',monospace;color:var(--success);font-weight:600}
    .action-btn{padding:6px 12px;border:1px solid var(--border);background:var(--bg-card);border-radius:var(--radius-sm);cursor:pointer;font-size:12px}.action-btn:hover{background:var(--bg-main)}.action-btn.danger{color:var(--danger);border-color:var(--danger-light)}.action-btn.danger:hover{background:var(--danger-light)}
    .modal-overlay{position:fixed;inset:0;background:rgba(13,31,26,0.6);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}.modal-overlay.active{display:flex}.modal{background:var(--bg-card);border-radius:var(--radius-lg);width:100%;max-width:600px;max-height:90vh;overflow:hidden}.modal-header{padding:24px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between}.modal-header h3{font-size:18px}.modal-close{width:36px;height:36px;border-radius:50%;border:none;background:var(--bg-main);cursor:pointer;font-size:18px}.modal-close:hover{background:var(--danger-light);color:var(--danger)}.modal-body{padding:24px;overflow-y:auto;max-height:calc(90vh - 160px)}.modal-footer{padding:20px 24px;border-top:1px solid var(--border-light);display:flex;justify-content:flex-end;gap:12px;background:var(--bg-main)}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}.form-group.full-width{grid-column:span 2}textarea.form-input{resize:vertical;min-height:80px}
    .totals-row{display:flex;justify-content:flex-end;gap:32px;padding:20px 24px;background:var(--bg-main);border-top:2px solid var(--border)}.total-item{text-align:right}.total-item label{font-size:12px;color:var(--text-secondary);text-transform:uppercase}.total-item .value{font-size:20px;font-weight:700;font-family:'Space Mono',monospace}.total-item .value.primary{color:var(--primary)}
    .page{display:none}.page.active{display:block}.filters{display:flex;gap:12px;margin-bottom:20px}.filter-select{padding:8px 16px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:13px;background:var(--bg-card)}
    .welcome-card{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border-radius:var(--radius-lg);padding:32px;color:#fff;margin-bottom:24px}.welcome-card h2{font-size:24px;margin-bottom:8px}.welcome-card p{opacity:0.8}
    .loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;z-index:1000}.loading-overlay .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--primary)}.loading-overlay.hidden{display:none}
    
    /* Mobile Menu Button */
    .mobile-menu-btn{display:none;position:fixed;top:16px;left:16px;z-index:150;width:48px;height:48px;border-radius:var(--radius-md);background:var(--primary);color:#fff;border:none;cursor:pointer;font-size:24px;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
    .mobile-menu-btn:active{background:var(--primary-dark);transform:scale(0.95)}
    .mobile-menu-btn.visible{display:flex!important}
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:90}
    .sidebar-overlay.active{display:block}
    
    /* Mobile Responsive */
    @media(max-width:768px){
      /* Sidebar Mobile */
      .sidebar{transform:translateX(-100%);transition:transform 0.3s ease;z-index:100}
      .sidebar.open{transform:translateX(0)}
      .main{margin-left:0}
      
      /* Header Mobile */
      .header{padding:16px;padding-left:70px;flex-direction:column;align-items:flex-start;gap:12px}
      .header h2{font-size:18px}
      .header-actions{width:100%;flex-wrap:wrap;gap:8px}
      .header-actions .btn{flex:1;min-width:120px;padding:10px 12px;font-size:13px}
      
      /* Stats Grid Mobile */
      .stats-grid{grid-template-columns:repeat(2,1fr)!important;gap:12px}
      .stat-card{padding:16px}
      .stat-value{font-size:20px}
      .stat-label{font-size:11px}
      
      /* Welcome Card Mobile */
      .welcome-card{padding:20px;margin-bottom:16px}
      .welcome-card h2{font-size:18px}
      
      /* Content Padding */
      .content{padding:16px}
      
      /* Cards Mobile */
      .card{margin-bottom:16px;border-radius:var(--radius-md)}
      .card-header{padding:16px}
      .card-header h3{font-size:14px}
      
      /* Tables Mobile - Horizontal Scroll */
      .card>table{display:block;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
      table{min-width:600px}
      th,td{padding:12px 10px;font-size:12px}
      
      /* Customer Cell Mobile */
      .customer-cell{gap:8px}
      .customer-avatar{width:32px;height:32px;font-size:11px}
      .customer-info .name{font-size:13px}
      .customer-info .id{font-size:10px}
      
      /* Totals Row Mobile */
      .totals-row{flex-wrap:wrap;gap:16px;padding:16px;justify-content:space-around}
      .total-item .value{font-size:16px}
      
      /* Filters Mobile */
      .filters{flex-wrap:wrap}
      .filter-select{flex:1;min-width:140px;font-size:12px;padding:10px 12px}
      #customerSearch{width:100%!important}
      
      /* Form Grid Mobile */
      .form-grid{grid-template-columns:1fr;gap:16px}
      .form-group.full-width{grid-column:span 1}
      
      /* Modal Mobile */
      .modal-overlay{padding:10px;align-items:flex-end}
      .modal{max-height:85vh;border-radius:var(--radius-lg) var(--radius-lg) 0 0}
      .modal-header{padding:16px}
      .modal-header h3{font-size:16px}
      .modal-body{padding:16px;max-height:calc(85vh - 140px)}
      .modal-footer{padding:16px;flex-direction:column}
      .modal-footer .btn{width:100%}
      
      /* Photo Preview Mobile */
      #photoPreview img,#currentPhotoImg{max-width:150px;max-height:100px}
      
      /* Action Buttons Mobile */
      .action-btn{padding:8px 10px;font-size:11px}
      
      /* Status Badge Mobile */
      .status-badge{padding:4px 8px;font-size:10px}
      
      /* Customer Detail Card Mobile */
      #customerDetailCard>div[style*="grid-template-columns"]{grid-template-columns:1fr 1fr!important;gap:12px!important;font-size:12px}
      
      /* Login Screen Mobile */
      .login-container{max-width:100%;margin:10px}
      .login-header{padding:24px}
      .login-header h1{font-size:18px}
      .login-body{padding:20px}
      
      /* Docs Screen Mobile */
      .docs-container{padding:0 10px}
      .docs-header{padding:20px 0}
      .docs-header h1{font-size:22px}
      .doc-card-header{padding:14px;flex-direction:column;gap:8px;align-items:flex-start}
      .doc-card-body{padding:16px;max-height:200px;font-size:12px}
      .doc-card-footer{padding:12px;flex-direction:column;gap:10px}
      .signature-input{width:100%;font-size:14px}
      .checkbox-group{align-items:flex-start}
      .checkbox-group label{font-size:12px}
      
      /* Hide less important columns on mobile */
      .hide-mobile{display:none!important}
    }
    
    /* Small phones */
    @media(max-width:380px){
      .stats-grid{grid-template-columns:1fr!important}
      .header-actions .btn{min-width:100%;font-size:12px}
      .welcome-card h2{font-size:16px}
      .stat-value{font-size:18px}
    }
    
    /* iOS Safe Areas */
    @supports(padding: max(0px)){
      .sidebar{padding-bottom:max(24px,env(safe-area-inset-bottom))}
      .modal{padding-bottom:max(20px,env(safe-area-inset-bottom))}
      .login-screen{padding:max(20px,env(safe-area-inset-top)) 20px max(20px,env(safe-area-inset-bottom))}
    }
    
    /* Touch improvements */
    @media(hover:none){
      .action-btn,.btn,.nav-item,.login-tab{min-height:44px}
      .form-input,.filter-select{min-height:44px;font-size:16px}
      .checkbox-group input{width:24px;height:24px}
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
  
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">â˜°</button>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>
  
  <!-- LOGIN SCREEN -->
  <div class="login-screen" id="loginScreen">
    <div class="login-container">
      <div class="login-header"><h1>GC<span>S</span></h1><h1>Guinea Cargo Services</h1><p>Shipping Portal</p></div>
      <div class="login-body">
        <div class="login-tabs"><button class="login-tab active" onclick="showLoginTab('signin')">Sign In</button><button class="login-tab" onclick="showLoginTab('signup')">Sign Up</button></div>
        <div id="errorMessage" class="error-message"></div><div id="successMessage" class="success-message"></div>
        <form id="signinForm" onsubmit="handleSignIn(event)"><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="signinEmail" required></div><div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="signinPassword" required></div><button type="submit" class="btn btn-primary" id="signinBtn">Sign In</button><p style="text-align:center;margin-top:16px"><a href="#" onclick="showLoginTab('reset');return false;" style="color:var(--primary);font-size:13px">Forgot password?</a></p></form>
        <form id="signupForm" style="display:none" onsubmit="handleSignUp(event)"><div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" id="signupName" required></div><div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="signupPhone" required></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="signupEmail" required></div><div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="signupPassword" minlength="6" required></div><button type="submit" class="btn btn-primary" id="signupBtn">Create Account</button></form>
        <form id="resetForm" style="display:none" onsubmit="handleReset(event)"><p style="font-size:13px;color:var(--text-secondary);margin-bottom:20px">Enter your email and we'll send you a link to reset your password.</p><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="resetEmail" required></div><button type="submit" class="btn btn-primary" id="resetBtn">Send Reset Link</button><p style="text-align:center;margin-top:16px"><a href="#" onclick="showLoginTab('signin');return false;" style="color:var(--primary);font-size:13px">Back to Sign In</a></p></form>
      </div>
    </div>
  </div>

  <!-- DOCUMENT SIGNING SCREEN -->
  <div class="docs-screen" id="docsScreen">
    <div class="docs-container">
      <div class="docs-header"><h1>Required Documents</h1><p>Please review and sign to continue</p></div>
      <div class="progress-text">Documents agreed: <span id="docsProgress">0</span> of 3</div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      
      <div class="doc-card"><div class="doc-card-header"><h3>1. Terms and Conditions</h3><span class="doc-status pending" id="doc1Status">Pending</span></div><div class="doc-card-body"><p><strong>GUINEA CARGO SERVICES - TERMS AND CONDITIONS</strong></p><h4>1. Services</h4><p>GCS provides freight consolidation and forwarding services from the USA to Guinea, Conakry.</p><h4>2. Rates and Payment</h4><p>Rates calculated by weight or volume. Payment required before departure.</p><h4>3. Packing</h4><p>Shipper responsible for proper packing. GCS not liable for damage from inadequate packaging.</p><h4>4. Transit Time</h4><p>Estimates are guidance only. Not liable for delays from customs, weather, or other factors.</p><h4>5. Customs</h4><p>Recipient responsible for all duties, taxes, and clearance fees in Guinea.</p></div><div class="doc-card-footer"><div class="checkbox-group"><input type="checkbox" id="doc1Check" onchange="checkDoc(1)"><label for="doc1Check">I agree to the Terms and Conditions</label></div></div></div>
      
      <div class="doc-card"><div class="doc-card-header"><h3>2. Shipper Authorization</h3><span class="doc-status pending" id="doc2Status">Pending</span></div><div class="doc-card-body"><p><strong>SHIPPER AUTHORIZATION</strong></p><p>I authorize Guinea Cargo Services to:</p><ul><li>Act as my forwarding agent for export control and customs</li><li>Prepare and sign shipping documents on my behalf</li><li>Make customs entries, declarations, and certificates</li><li>Arrange transportation to the destination</li></ul><p>I declare all information provided is accurate and I am authorized to ship these goods.</p></div><div class="doc-card-footer"><div class="checkbox-group"><input type="checkbox" id="doc2Check" onchange="checkDoc(2)"><label for="doc2Check">I authorize GCS to act on my behalf</label></div></div></div>
      
      <div class="doc-card"><div class="doc-card-header"><h3>3. Liability Waiver and Prohibited Items</h3><span class="doc-status pending" id="doc3Status">Pending</span></div><div class="doc-card-body"><p><strong>LIABILITY LIMITATION</strong></p><ul><li>GCS liability limited to $100 per shipment or declared value (whichever less)</li><li>Not liable for: acts of God, war, customs seizure, improper packing</li><li>Additional cargo insurance available upon request</li></ul><h4>Prohibited Items Declaration</h4><p>I confirm shipments will NOT contain: hazardous materials, explosives, illegal drugs, weapons/firearms, currency, perishable food (unless arranged), live animals, counterfeit goods, or items prohibited by US export or Guinea import law.</p></div><div class="doc-card-footer"><div class="checkbox-group"><input type="checkbox" id="doc3Check" onchange="checkDoc(3)"><label for="doc3Check">I understand liability limits and confirm no prohibited items</label></div></div></div>
      
      <div class="doc-card" id="signatureCard" style="display:none"><div class="doc-card-header"><h3>Electronic Signature</h3></div><div class="doc-card-body"><p>By typing your full legal name, you electronically sign all documents above.</p><p style="margin-top:16px"><strong>Date:</strong> <span id="signDate"></span></p></div><div class="doc-card-footer"><input type="text" class="signature-input" id="signatureInput" placeholder="Type your full legal name"><button class="btn btn-primary" style="width:auto" onclick="submitSignature()">Sign and Continue</button></div></div>
      
      <div style="text-align:center;padding:32px"><button class="btn btn-secondary" onclick="handleLogout()" style="width:auto;padding:12px 32px">Cancel</button></div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="app-container" id="appContainer">
    <aside class="sidebar">
      <div class="logo"><h1>GC<span>S</span><span class="role-badge" id="roleBadge">Customer</span></h1><p>Shipping Portal</p></div>
      
      <!-- ADMIN NAVIGATION -->
      <nav class="nav-section" id="adminNav" style="display:none">
        <a class="nav-item active" data-page="adminDashboard"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Overview</a>
        <a class="nav-item" data-page="adminCustomers"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Customers<span class="nav-badge" id="adminCustomerCount">0</span></a>
        <a class="nav-item" data-page="adminInventory"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>All Inventory<span class="nav-badge" id="adminInventoryCount">0</span></a>
        <a class="nav-item" data-page="adminShipments"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>Shipments<span class="nav-badge" id="adminShipmentCount">0</span></a>
        <a class="nav-item" data-page="adminReports"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Reports</a>
      </nav>
      
      <!-- CUSTOMER NAVIGATION -->
      <nav class="nav-section" id="customerNav">
        <a class="nav-item active" data-page="customerDashboard"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Dashboard</a>
        <a class="nav-item" data-page="customerInventory"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>My Items<span class="nav-badge" id="customerInventoryCount">0</span></a>
        <a class="nav-item" data-page="customerDocuments"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Documents</a>
      </nav>
      
      <div class="sidebar-footer"><div class="user-info"><div class="name" id="userName">User</div><div class="email" id="userEmail">-</div></div><button class="logout-btn" onclick="handleLogout()">Sign Out</button></div>
    </aside>
    
    <main class="main">
      <!-- ============================================== -->
      <!-- ADMIN PAGES -->
      <!-- ============================================== -->
      
      <!-- ADMIN DASHBOARD -->
      <div class="page" id="adminDashboard">
        <header class="header"><div><h2>Admin Overview</h2><p>Manage Guinea Cargo Services</p></div><div class="header-actions"><button class="btn btn-secondary" onclick="exportAllData()">Export All</button><button class="btn btn-primary" onclick="refreshData()">Refresh</button></div></header>
        <div class="content">
          <div class="welcome-card"><h2 id="adminWelcomeText">Welcome, Admin!</h2><p>Shipment Management Console</p></div>
          
          <div class="stats-grid">
            <div class="stat-card highlight"><div class="stat-label">Total Weight</div><div class="stat-value" id="adminStatWeight">0 lbs</div></div>
            <div class="stat-card"><div class="stat-label">Customers</div><div class="stat-value" id="adminStatCustomers">0</div></div>
            <div class="stat-card"><div class="stat-label">Total Value</div><div class="stat-value" id="adminStatValue">$0</div></div>
            <div class="stat-card"><div class="stat-label">Total Items</div><div class="stat-value" id="adminStatItems">0</div></div>
          </div>
          
          <div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">
            <div class="stat-card"><div class="stat-label">Pending Items</div><div class="stat-value" id="adminStatPending" style="color:var(--accent)">0</div></div>
            <div class="stat-card"><div class="stat-label">Submitted Items</div><div class="stat-value" id="adminStatSubmitted" style="color:var(--success)">0</div></div>
            <div class="stat-card"><div class="stat-label">Unsigned Customers</div><div class="stat-value" id="adminStatUnsigned" style="color:var(--danger)">0</div></div>
          </div>
          
          <div class="card">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
              <h3>Recent Customers</h3>
              <a href="#" onclick="navigateTo('adminCustomers');return false;" style="color:var(--primary);font-size:13px">View All â†’</a>
            </div>
            <table>
              <thead><tr><th>Customer</th><th>Email</th><th>Items</th><th>Weight</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="adminRecentCustomersTable"></tbody>
            </table>
          </div>
          
          <div class="card">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
              <h3>Recent Items</h3>
              <a href="#" onclick="navigateTo('adminInventory');return false;" style="color:var(--primary);font-size:13px">View All â†’</a>
            </div>
            <table>
              <thead><tr><th>Date</th><th>Customer</th><th>Description</th><th>Weight</th><th>Value</th><th>Status</th></tr></thead>
              <tbody id="adminRecentItemsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ADMIN CUSTOMERS PAGE -->
      <div class="page" id="adminCustomers">
        <header class="header">
          <div><h2>All Customers</h2><p>Manage customer accounts and inventory</p></div>
          <div class="header-actions">
            <input type="text" class="form-input" id="adminCustomerSearch" placeholder="Search..." style="width:200px" oninput="renderAdminCustomers()">
            <button class="btn btn-secondary" onclick="exportCustomers()">Export</button>
          </div>
        </header>
        <div class="content">
          <div class="filters">
            <select class="filter-select" id="adminCustomerFilter" onchange="renderAdminCustomers()">
              <option value="all">All Customers</option>
              <option value="with-items">With Items</option>
              <option value="no-items">No Items</option>
              <option value="pending">Pending Submission</option>
              <option value="submitted">Submitted</option>
              <option value="unsigned">Unsigned Docs</option>
            </select>
          </div>
          <div class="card">
            <table>
              <thead><tr><th>Customer</th><th>Phone</th><th>Email</th><th>Items</th><th>Weight</th><th>Value</th><th>Docs</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="adminCustomersTable"></tbody>
            </table>
          </div>
          
          <!-- Customer Detail Panel -->
          <div class="card" id="adminCustomerDetail" style="display:none">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;background:var(--primary);color:#fff;margin:-1px;padding:20px 24px">
              <div>
                <h3 id="adminDetailName" style="margin-bottom:4px">Customer Name</h3>
                <span id="adminDetailEmail" style="opacity:0.8;font-size:13px"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2b4e464a42476b4e534a465b474e05484446">[email&#160;protected]</a></span>
              </div>
              <div>
                <button class="btn" onclick="addItemForSelectedCustomer()" style="background:var(--accent);color:#000;margin-right:8px">Add Item</button>
                <button class="btn" onclick="closeAdminCustomerDetail()" style="background:rgba(255,255,255,0.2);color:#fff">Close</button>
              </div>
            </div>
            <div style="padding:20px;background:var(--bg-main);display:grid;grid-template-columns:repeat(5,1fr);gap:16px;font-size:13px">
              <div><strong>Phone:</strong><br><span id="adminDetailPhone">-</span></div>
              <div><strong>Signed Up:</strong><br><span id="adminDetailSignup">-</span></div>
              <div><strong>Documents:</strong><br><span id="adminDetailDocs">-</span></div>
              <div><strong>Total Weight:</strong><br><span id="adminDetailWeight">-</span></div>
              <div><strong>Total Value:</strong><br><span id="adminDetailValue">-</span></div>
            </div>
            <table>
              <thead><tr><th>Item ID</th><th>Photo</th><th>Description</th><th>Category</th><th>Qty</th><th>Weight</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="adminCustomerItemsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ADMIN ALL INVENTORY PAGE -->
      <div class="page" id="adminInventory">
        <header class="header">
          <div><h2>All Inventory</h2><p>View and manage all customer items</p></div>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
            <button class="btn btn-primary" onclick="openModal('itemModal')">Add Item</button>
          </div>
        </header>
        <div class="content">
          <div class="filters" style="flex-wrap:wrap;gap:12px">
            <select class="filter-select" id="adminInvCustomerFilter" onchange="renderAdminInventory()">
              <option value="">All Customers</option>
            </select>
            <select class="filter-select" id="adminInvCategoryFilter" onchange="renderAdminInventory()">
              <option value="">All Categories</option>
              <option value="electronics">Electronics</option>
              <option value="clothing">Clothing</option>
              <option value="appliances">Appliances</option>
              <option value="household">Household</option>
              <option value="other">Other</option>
            </select>
            <select class="filter-select" id="adminInvStatusFilter" onchange="renderAdminInventory()">
              <option value="">All Status</option>
              <option value="received">Pending</option>
              <option value="submitted">Submitted</option>
            </select>
          </div>
          <div class="card">
            <table>
              <thead><tr><th>ID</th><th>Customer</th><th>Photo</th><th>Description</th><th>Category</th><th>Weight</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="adminInventoryTable"></tbody>
            </table>
            <div class="totals-row">
              <div class="total-item"><label>Items</label><div class="value" id="adminInvTotalItems">0</div></div>
              <div class="total-item"><label>Weight</label><div class="value" id="adminInvTotalWeight">0 lbs</div></div>
              <div class="total-item"><label>Value</label><div class="value primary" id="adminInvTotalValue">$0</div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ADMIN REPORTS PAGE -->
      <div class="page" id="adminReports">
        <header class="header"><div><h2>Reports</h2><p>Export and analyze data</p></div></header>
        <div class="content">
          <div class="stats-grid" style="grid-template-columns:repeat(2,1fr)">
            <div class="card" style="cursor:pointer" onclick="exportAllData()">
              <div class="card-header"><h3>ðŸ“Š Full Export</h3></div>
              <div style="padding:20px;color:var(--text-secondary)">Export all customers and inventory data to CSV</div>
            </div>
            <div class="card" style="cursor:pointer" onclick="exportCustomers()">
              <div class="card-header"><h3>ðŸ‘¥ Customers Report</h3></div>
              <div style="padding:20px;color:var(--text-secondary)">Export customer list with totals</div>
            </div>
            <div class="card" style="cursor:pointer" onclick="exportCSV()">
              <div class="card-header"><h3>ðŸ“¦ Inventory Report</h3></div>
              <div style="padding:20px;color:var(--text-secondary)">Export all inventory items</div>
            </div>
            <div class="card" style="cursor:pointer" onclick="exportSubmitted()">
              <div class="card-header"><h3>âœ… Submitted Items</h3></div>
              <div style="padding:20px;color:var(--text-secondary)">Export only submitted items ready for shipping</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ADMIN SHIPMENTS PAGE -->
      <div class="page" id="adminShipments">
        <header class="header">
          <div><h2>Shipments</h2><p>Manage container shipments</p></div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="openModal('shipmentModal')">+ New Shipment</button>
          </div>
        </header>
        <div class="content">
          <!-- Shipments List -->
          <div class="card">
            <div class="card-header"><h3>All Shipments</h3></div>
            <table>
              <thead><tr><th>Shipment ID</th><th>Name</th><th>Date</th><th>Items</th><th>Weight</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="shipmentsTable"></tbody>
            </table>
          </div>
          
          <!-- Shipment Detail Panel -->
          <div class="card" id="shipmentDetailPanel" style="display:none">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;background:var(--primary);color:#fff;margin:-1px;padding:20px 24px">
              <div>
                <h3 id="shipmentDetailName" style="margin-bottom:4px">Shipment Name</h3>
                <span id="shipmentDetailId" style="opacity:0.8;font-size:13px">SHP-000</span>
              </div>
              <div>
                <button class="btn" onclick="addItemsToShipment()" style="background:var(--accent);color:#000;margin-right:8px">+ Add Items</button>
                <button class="btn" onclick="exportShipment()" style="background:rgba(255,255,255,0.2);color:#fff;margin-right:8px">Export</button>
                <button class="btn" onclick="closeShipmentDetail()" style="background:rgba(255,255,255,0.2);color:#fff">Close</button>
              </div>
            </div>
            <div style="padding:20px;background:var(--bg-main);display:grid;grid-template-columns:repeat(5,1fr);gap:16px;font-size:13px">
              <div><strong>Created:</strong><br><span id="shipmentDetailDate">-</span></div>
              <div><strong>Status:</strong><br><span id="shipmentDetailStatus">-</span></div>
              <div><strong>Items:</strong><br><span id="shipmentDetailItems">0</span></div>
              <div><strong>Total Weight:</strong><br><span id="shipmentDetailWeight">0 lbs</span></div>
              <div><strong>Total Value:</strong><br><span id="shipmentDetailValue">$0</span></div>
            </div>
            <div style="padding:16px;background:var(--bg-main);border-bottom:1px solid var(--border)">
              <strong>Notes:</strong> <span id="shipmentDetailNotes" style="color:var(--text-secondary)">-</span>
            </div>
            <table>
              <thead><tr><th><input type="checkbox" id="selectAllShipmentItems" onchange="toggleAllShipmentItems()"></th><th>Item ID</th><th>Customer</th><th>Description</th><th>Weight</th><th>Value</th><th>Actions</th></tr></thead>
              <tbody id="shipmentItemsTable"></tbody>
            </table>
            <div class="totals-row">
              <button class="btn" style="background:var(--danger);color:#fff" onclick="removeSelectedFromShipment()">Remove Selected</button>
              <div style="display:flex;gap:32px">
                <div class="total-item"><label>Items</label><div class="value" id="shipmentTotalItems">0</div></div>
                <div class="total-item"><label>Weight</label><div class="value" id="shipmentTotalWeight">0 lbs</div></div>
                <div class="total-item"><label>Value</label><div class="value primary" id="shipmentTotalValue">$0</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================== --> -->
      <!-- CUSTOMER PAGES -->
      <!-- ============================================== -->
      
      <!-- CUSTOMER DASHBOARD -->
      <div class="page" id="customerDashboard">
        <header class="header"><div><h2>My Dashboard</h2><p>Track your shipments to Guinea</p></div><div class="header-actions"><button class="btn btn-primary" onclick="openModal('itemModal')">Add Item</button></div></header>
        <div class="content">
          <div class="welcome-card"><h2 id="customerWelcomeText">Welcome!</h2><p>Track your shipments to Guinea</p></div>
          
          <div class="stats-grid">
            <div class="stat-card highlight"><div class="stat-label">Total Weight</div><div class="stat-value" id="customerStatWeight">0 lbs</div></div>
            <div class="stat-card"><div class="stat-label">My Items</div><div class="stat-value" id="customerStatItems">0</div></div>
            <div class="stat-card"><div class="stat-label">Total Value</div><div class="stat-value" id="customerStatValue">$0</div></div>
            <div class="stat-card"><div class="stat-label">Status</div><div class="stat-value" id="customerStatStatus" style="font-size:14px">-</div></div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3>My Recent Items</h3></div>
            <table>
              <thead><tr><th>ID</th><th>Photo</th><th>Description</th><th>Weight</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="customerRecentItemsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CUSTOMER INVENTORY PAGE -->
      <div class="page" id="customerInventory">
        <header class="header">
          <div><h2>My Items</h2><p>Manage your inventory</p></div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="openModal('itemModal')">Add Item</button>
            <button class="btn" id="customerSubmitBtn" style="background:var(--accent);display:none" onclick="submitInventory()">Submit Final Inventory</button>
          </div>
        </header>
        <div class="content">
          <div class="card">
            <table>
              <thead><tr><th>ID</th><th>Photo</th><th>Description</th><th>Category</th><th>Weight</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="customerInventoryTable"></tbody>
            </table>
            <div class="totals-row">
              <div class="total-item"><label>Items</label><div class="value" id="customerInvTotalItems">0</div></div>
              <div class="total-item"><label>Weight</label><div class="value" id="customerInvTotalWeight">0 lbs</div></div>
              <div class="total-item"><label>Value</label><div class="value primary" id="customerInvTotalValue">$0</div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- CUSTOMER DOCUMENTS PAGE -->
      <div class="page" id="customerDocuments">
        <header class="header"><div><h2>My Documents</h2><p>View signed agreements</p></div></header>
        <div class="content">
          <div class="card">
            <table>
              <thead><tr><th>Document</th><th>Signed Date</th><th>Signature</th><th>Actions</th></tr></thead>
              <tbody id="customerDocsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- ADD/EDIT ITEM MODAL -->
        <header class="header"><div><h2 id="inventoryTitle">My Items</h2><p id="inventorySubtitle">Track your items</p></div><div class="header-actions"><button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button><button class="btn btn-primary" onclick="openModal('itemModal')">Add Item</button><button class="btn btn-primary" id="submitInventoryBtn" style="background:var(--accent);display:none" onclick="submitInventory()">Submit Final Inventory</button></div></header>
        <div class="content">
          <div class="filters admin-only"><select class="filter-select" id="filterCustomer" onchange="renderInventory()"><option value="">All Customers</option></select></div>
          <div class="filters"><select class="filter-select" id="filterCategory" onchange="renderInventory()"><option value="">All Categories</option><option value="electronics">Electronics</option><option value="clothing">Clothing</option><option value="appliances">Appliances</option><option value="household">Household</option><option value="other">Other</option></select></div>
          <div class="card"><table><thead><tr><th>ID</th><th class="admin-only">Customer</th><th>Photo</th><th>Description</th><th>Category</th><th>Weight</th><th>Value</th><th>Actions</th></tr></thead><tbody id="inventoryTable"></tbody></table><div class="totals-row"><div class="total-item"><label>Items</label><div class="value" id="totalItems">0</div></div><div class="total-item"><label>Weight</label><div class="value" id="totalWeight">0 lbs</div></div><div class="total-item"><label>Value</label><div class="value primary" id="totalValue">$0</div></div></div></div>
        </div>
      </div>

      <!-- DOCUMENTS PAGE -->
      <div class="page" id="documents">
        <header class="header"><div><h2>My Documents</h2><p>View and download signed agreements</p></div></header>
        <div class="content"><div class="card"><div class="card-header"><h3>Signed Documents</h3></div><table><thead><tr><th>Document</th><th>Signed Date</th><th>Signature</th><th>Actions</th></tr></thead><tbody id="docsTable"></tbody></table></div></div>
      </div>
    </main>
  </div>

  <!-- ADD/EDIT ITEM MODAL -->
  <div class="modal-overlay" id="itemModal">
    <div class="modal">
      <div class="modal-header"><h3 id="itemModalTitle">Add Item</h3><button class="modal-close" onclick="closeModal('itemModal')">Ã—</button></div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full-width admin-only"><label class="form-label">Customer</label><select class="form-input" id="itemCustomer"></select></div>
          <div class="form-group full-width"><label class="form-label">Description *</label><input type="text" class="form-input" id="itemDesc" placeholder="e.g. Samsung 55 inch TV"></div>
          <div class="form-group"><label class="form-label">Category</label><select class="form-input" id="itemCategory"><option value="electronics">Electronics</option><option value="clothing">Clothing</option><option value="appliances">Appliances</option><option value="household">Household</option><option value="other">Other</option></select></div>
          <div class="form-group"><label class="form-label">Quantity</label><input type="number" class="form-input" id="itemQty" value="1" min="1"></div>
          <div class="form-group"><label class="form-label">Weight (lbs)</label><input type="number" class="form-input" id="itemWeight" value="0" step="0.1"></div>
          <div class="form-group"><label class="form-label">Value ($)</label><input type="number" class="form-input" id="itemValue" value="0" step="0.01"></div>
          <div class="form-group full-width">
            <label class="form-label">Photo * (JPEG or PNG, max 5MB)</label>
            <input type="file" class="form-input" id="itemPhoto" accept=".jpg,.jpeg,.png" onchange="previewPhoto(this)" style="padding:8px">
            <div id="photoPreview" style="margin-top:10px;display:none">
              <img id="photoPreviewImg" style="max-width:200px;max-height:150px;border-radius:8px;border:1px solid var(--border)">
              <button type="button" onclick="clearPhoto()" style="margin-left:10px;padding:4px 8px;font-size:12px;cursor:pointer">Remove</button>
            </div>
            <div id="currentPhoto" style="margin-top:10px;display:none">
              <p style="font-size:12px;color:var(--text-secondary);margin-bottom:5px">Current photo:</p>
              <img id="currentPhotoImg" style="max-width:200px;max-height:150px;border-radius:8px;border:1px solid var(--border)">
            </div>
          </div>
          <div class="form-group full-width"><label class="form-label">Notes</label><textarea class="form-input" id="itemNotes" placeholder="Optional notes"></textarea></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('itemModal')">Cancel</button><button class="btn btn-primary" id="saveItemBtn" onclick="saveItem()">Add Item</button></div>
    </div>
  </div>

  <!-- NEW SHIPMENT MODAL -->
  <div class="modal-overlay" id="shipmentModal">
    <div class="modal">
      <div class="modal-header"><h3 id="shipmentModalTitle">New Shipment</h3><button class="modal-close" onclick="closeModal('shipmentModal')">Ã—</button></div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full-width"><label class="form-label">Shipment Name *</label><input type="text" class="form-input" id="shipmentName" placeholder="e.g. January 2025 Container"></div>
          <div class="form-group"><label class="form-label">Target Date</label><input type="date" class="form-input" id="shipmentDate"></div>
          <div class="form-group"><label class="form-label">Status</label><select class="form-input" id="shipmentStatus"><option value="planning">Planning</option><option value="loading">Loading</option><option value="shipped">Shipped</option><option value="delivered">Delivered</option></select></div>
          <div class="form-group full-width"><label class="form-label">Notes</label><textarea class="form-input" id="shipmentNotes" placeholder="Optional notes about this shipment"></textarea></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('shipmentModal')">Cancel</button><button class="btn btn-primary" onclick="saveShipment()">Create Shipment</button></div>
    </div>
  </div>

  <!-- ADD ITEMS TO SHIPMENT MODAL -->
  <div class="modal-overlay" id="addToShipmentModal">
    <div class="modal" style="max-width:900px">
      <div class="modal-header"><h3>Add Items to Shipment</h3><button class="modal-close" onclick="closeModal('addToShipmentModal')">Ã—</button></div>
      <div class="modal-body" style="max-height:60vh">
        <div class="filters" style="margin-bottom:16px;flex-wrap:wrap;gap:12px">
          <select class="filter-select" id="addShipmentCustomerFilter" onchange="renderAvailableItems()">
            <option value="">All Customers</option>
          </select>
          <select class="filter-select" id="addShipmentStatusFilter" onchange="renderAvailableItems()">
            <option value="">All Status</option>
            <option value="submitted">Submitted Only</option>
            <option value="received">Pending Only</option>
          </select>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px">
            <input type="checkbox" id="hideAssignedItems" onchange="renderAvailableItems()" checked> Hide already assigned
          </label>
        </div>
        <table>
          <thead><tr><th><input type="checkbox" id="selectAllAvailable" onchange="toggleAllAvailable()"></th><th>Item ID</th><th>Customer</th><th>Description</th><th>Weight</th><th>Value</th><th>Status</th></tr></thead>
          <tbody id="availableItemsTable"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <div style="flex:1;text-align:left;font-size:13px;color:var(--text-secondary)"><span id="selectedItemCount">0</span> items selected</div>
        <button class="btn btn-secondary" onclick="closeModal('addToShipmentModal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmAddToShipment()">Add Selected</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    var SUPABASE_URL = 'https://usxkawrvasiidlsludjc.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzeGthd3J2YXNpaWRsc2x1ZGpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Nzg5MjMsImV4cCI6MjA4NTE1NDkyM30.AAkyRqAywxkXv3aO0uNIf7RuG1lCxrcS89wHJKqlunQ';

    // ==================== STATE ====================
    var sb = null;
    var currentUser = null;
    var userRole = 'customer';
    var userProfile = null;
    var customers = [];
    var inventory = [];
    var signedDocs = [];
    var shipments = [];
    var currentShipmentId = null;
    var docsChecked = {1: false, 2: false, 3: false};
    var editingItemId = null;
    var selectedPhotoFile = null;

    // ==================== INITIALIZATION ====================
    function initApp() {
      if (typeof window.supabase === 'undefined') {
        hideLoading();
        alert('Could not load Supabase. Please refresh.');
        return;
      }
      
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      
      sb.auth.getSession().then(function(r) {
        if (r.data.session) {
          currentUser = r.data.session.user;
          loadUserProfile();
        } else {
          hideLoading();
        }
      });
      
      sb.auth.onAuthStateChange(function(event, session) {
        if (event === 'SIGNED_IN' && session) {
          currentUser = session.user;
          loadUserProfile();
        } else if (event === 'SIGNED_OUT') {
          currentUser = null;
          userRole = 'customer';
          userProfile = null;
          customers = [];
          inventory = [];
          signedDocs = [];
          hideAll();
          document.getElementById('loginScreen').classList.remove('hidden');
        }
      });
    }

    // ==================== USER PROFILE ====================
    function loadUserProfile() {
      sb.from('profiles').select('*').eq('id', currentUser.id).single().then(function(r) {
        if (r.data) {
          userProfile = r.data;
          userRole = r.data.role || 'customer';
        } else {
          userProfile = null;
          userRole = 'customer';
        }
        
        // Admin skips document signing
        if (userRole === 'admin') {
          showApp();
          loadData();
        } else {
          checkDocsSigned();
        }
      });
    }

    // ==================== DOCUMENT SIGNING ====================
    function checkDocsSigned() {
      sb.from('signed_documents').select('*').eq('user_id', currentUser.id).then(function(r) {
        signedDocs = r.data || [];
        if (signedDocs.length >= 3) {
          showApp();
          loadData();
        } else {
          showDocsScreen();
        }
      });
    }

    function showDocsScreen() {
      hideLoading();
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('show');
      document.getElementById('docsScreen').classList.add('show');
      document.getElementById('signDate').textContent = new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
      docsChecked = {1: false, 2: false, 3: false};
      document.getElementById('doc1Check').checked = false;
      document.getElementById('doc2Check').checked = false;
      document.getElementById('doc3Check').checked = false;
      updateDocsProgress();
    }

    function checkDoc(num) {
      docsChecked[num] = document.getElementById('doc' + num + 'Check').checked;
      document.getElementById('doc' + num + 'Status').textContent = docsChecked[num] ? 'Agreed' : 'Pending';
      document.getElementById('doc' + num + 'Status').className = 'doc-status ' + (docsChecked[num] ? 'signed' : 'pending');
      updateDocsProgress();
    }

    function updateDocsProgress() {
      var count = 0;
      if (docsChecked[1]) count++;
      if (docsChecked[2]) count++;
      if (docsChecked[3]) count++;
      document.getElementById('docsProgress').textContent = count;
      document.getElementById('progressFill').style.width = (count / 3 * 100) + '%';
      document.getElementById('signatureCard').style.display = count === 3 ? 'block' : 'none';
    }

    function submitSignature() {
      var sig = document.getElementById('signatureInput').value.trim();
      if (!sig) {
        alert('Please type your full legal name');
        return;
      }
      if (sig.split(' ').length < 2) {
        alert('Please enter first and last name');
        return;
      }
      
      var now = new Date().toISOString();
      var docs = [
        {user_id: currentUser.id, doc_type: 'terms_conditions', doc_title: 'Terms and Conditions', signature: sig, signed_at: now},
        {user_id: currentUser.id, doc_type: 'shipper_auth', doc_title: 'Shipper Authorization', signature: sig, signed_at: now},
        {user_id: currentUser.id, doc_type: 'liability_waiver', doc_title: 'Liability Waiver', signature: sig, signed_at: now}
      ];
      
      sb.from('signed_documents').insert(docs).then(function(r) {
        if (r.error) {
          alert('Error saving documents: ' + r.error.message);
          return;
        }
        signedDocs = docs;
        document.getElementById('docsScreen').classList.remove('show');
        document.getElementById('signatureInput').value = '';
        showApp();
        loadData();
      });
    }

    // ==================== UI HELPERS ====================
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function hideAll() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('docsScreen').classList.remove('show');
      document.getElementById('appContainer').classList.remove('show');
    }

    function showApp() {
      hideLoading();
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('docsScreen').classList.remove('show');
      document.getElementById('appContainer').classList.add('show');
      
      // Get user name
      var name = 'User';
      if (userProfile && userProfile.full_name) {
        name = userProfile.full_name;
      } else if (currentUser && currentUser.user_metadata && currentUser.user_metadata.full_name) {
        name = currentUser.user_metadata.full_name;
      }
      
      // Update common UI
      document.getElementById('userName').textContent = name;
      document.getElementById('userEmail').textContent = currentUser.email || '-';
      document.getElementById('roleBadge').textContent = userRole === 'admin' ? 'Admin' : 'Customer';
      
      // Show correct navigation and pages based on role
      if (userRole === 'admin') {
        // Show admin interface
        document.getElementById('adminNav').style.display = 'block';
        document.getElementById('customerNav').style.display = 'none';
        document.getElementById('adminWelcomeText').textContent = 'Welcome, ' + name + '!';
        
        // Show admin dashboard, hide customer pages
        document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
        document.getElementById('adminDashboard').classList.add('active');
        
        // Set active nav
        document.querySelectorAll('#adminNav .nav-item').forEach(function(n) { n.classList.remove('active'); });
        document.querySelector('#adminNav .nav-item[data-page="adminDashboard"]').classList.add('active');
      } else {
        // Show customer interface
        document.getElementById('adminNav').style.display = 'none';
        document.getElementById('customerNav').style.display = 'block';
        document.getElementById('customerWelcomeText').textContent = 'Welcome, ' + name + '!';
        
        // Show customer dashboard, hide admin pages
        document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
        document.getElementById('customerDashboard').classList.add('active');
        
        // Set active nav
        document.querySelectorAll('#customerNav .nav-item').forEach(function(n) { n.classList.remove('active'); });
        document.querySelector('#customerNav .nav-item[data-page="customerDashboard"]').classList.add('active');
      }
      
      // Update mobile menu visibility
      if (typeof updateMobileMenuVisibility === 'function') {
        updateMobileMenuVisibility();
      }
    }

    // ==================== AUTH ====================
    function showLoginTab(tab) {
      document.querySelectorAll('.login-tab').forEach(function(t) {
        t.classList.remove('active');
      });
      if (tab === 'signin' || tab === 'signup') {
        document.querySelectorAll('.login-tab')[tab === 'signin' ? 0 : 1].classList.add('active');
      }
      document.getElementById('signinForm').style.display = tab === 'signin' ? 'block' : 'none';
      document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
      document.getElementById('resetForm').style.display = tab === 'reset' ? 'block' : 'none';
      document.getElementById('errorMessage').classList.remove('show');
      document.getElementById('successMessage').classList.remove('show');
    }

    function showError(msg) {
      document.getElementById('errorMessage').textContent = msg;
      document.getElementById('errorMessage').classList.add('show');
      document.getElementById('successMessage').classList.remove('show');
    }

    function showSuccess(msg) {
      document.getElementById('successMessage').textContent = msg;
      document.getElementById('successMessage').classList.add('show');
      document.getElementById('errorMessage').classList.remove('show');
    }

    function handleReset(e) {
      e.preventDefault();
      var email = document.getElementById('resetEmail').value;
      var btn = document.getElementById('resetBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';
      
      sb.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + window.location.pathname
      }).then(function(r) {
        btn.disabled = false;
        btn.textContent = 'Send Reset Link';
        if (r.error) {
          showError(r.error.message);
        } else {
          showSuccess('Password reset link sent! Check your email.');
        }
      });
    }

    function handleSignIn(e) {
      e.preventDefault();
      var email = document.getElementById('signinEmail').value;
      var pw = document.getElementById('signinPassword').value;
      var btn = document.getElementById('signinBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';
      
      sb.auth.signInWithPassword({email: email, password: pw}).then(function(r) {
        btn.disabled = false;
        btn.textContent = 'Sign In';
        if (r.error) {
          showError(r.error.message);
        } else {
          clearLoginForms();
        }
      });
    }

    function handleSignUp(e) {
      e.preventDefault();
      var name = document.getElementById('signupName').value;
      var phone = document.getElementById('signupPhone').value;
      var email = document.getElementById('signupEmail').value;
      var pw = document.getElementById('signupPassword').value;
      var btn = document.getElementById('signupBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';
      
      sb.auth.signUp({
        email: email,
        password: pw,
        options: {data: {full_name: name, phone: phone}}
      }).then(function(r) {
        btn.disabled = false;
        btn.textContent = 'Create Account';
        if (r.error) {
          showError(r.error.message);
        } else if (r.data.session) {
          // Auto-signed in (email confirmation disabled)
          currentUser = r.data.session.user;
          userRole = 'customer';
          userProfile = {full_name: name, phone: phone, role: 'customer'};
          clearLoginForms();
          showDocsScreen();
        } else {
          // Email confirmation required
          showSuccess('Account created! Check email to verify.');
          clearLoginForms();
        }
      });
    }

    function handleLogout() {
      sb.auth.signOut();
      clearLoginForms();
    }

    function clearLoginForms() {
      document.getElementById('signinEmail').value = '';
      document.getElementById('signinPassword').value = '';
      document.getElementById('signupName').value = '';
      document.getElementById('signupPhone').value = '';
      document.getElementById('signupEmail').value = '';
      document.getElementById('signupPassword').value = '';
      document.getElementById('resetEmail').value = '';
      document.getElementById('errorMessage').classList.remove('show');
      document.getElementById('successMessage').classList.remove('show');
    }

    // ==================== DATA LOADING ====================
    function loadData() {
      // Update mobile menu visibility
      setTimeout(updateMobileMenuVisibility, 100);
      
      // Load signed documents for current user
      sb.from('signed_documents').select('*').eq('user_id', currentUser.id).then(function(r) {
        signedDocs = r.data || [];
        renderDocs();
      });
      
      if (userRole === 'admin') {
        // Admin: load all profiles and all inventory
        sb.from('profiles').select('*').order('created_at', {ascending: false}).then(function(r) {
          customers = r.data || [];
          loadCustomerDocs();
        });
        
        sb.from('inventory').select('*').order('created_at', {ascending: false}).then(function(r) {
          inventory = r.data || [];
          renderAll();
          updateMobileMenuVisibility();
        });
        
        // Load shipments
        loadShipments();
      } else {
        // Customer: load only their inventory
        sb.from('inventory').select('*').eq('user_id', currentUser.id).order('created_at', {ascending: false}).then(function(r) {
          inventory = r.data || [];
          renderAll();
          updateMobileMenuVisibility();
        });
      }
    }

    function loadShipments() {
      sb.from('shipments').select('*').order('created_at', {ascending: false}).then(function(r) {
        shipments = r.data || [];
        renderShipments();
      });
    }

    function loadCustomerDocs() {
      sb.from('signed_documents').select('user_id').then(function(r) {
        var docCounts = {};
        (r.data || []).forEach(function(d) {
          docCounts[d.user_id] = (docCounts[d.user_id] || 0) + 1;
        });
        customers.forEach(function(c) {
          c.docs_count = docCounts[c.id] || 0;
        });
        renderAll();
      });
    }

    // ==================== INVENTORY OPERATIONS ====================
    function previewPhoto(input) {
      var file = input.files[0];
      if (!file) return;
      
      // Validate file type
      var validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
      if (!validTypes.includes(file.type)) {
        alert('Please select a JPEG or PNG image');
        input.value = '';
        return;
      }
      
      // Validate file size (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        input.value = '';
        return;
      }
      
      selectedPhotoFile = file;
      var reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('photoPreviewImg').src = e.target.result;
        document.getElementById('photoPreview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    function clearPhoto() {
      document.getElementById('itemPhoto').value = '';
      document.getElementById('photoPreview').style.display = 'none';
      document.getElementById('photoPreviewImg').src = '';
      selectedPhotoFile = null;
    }

    async function uploadPhoto(file, itemId) {
      var fileExt = file.name.split('.').pop();
      var fileName = itemId + '_' + Date.now() + '.' + fileExt;
      var filePath = currentUser.id + '/' + fileName;
      
      var { data, error } = await sb.storage.from('item-photos').upload(filePath, file);
      if (error) throw error;
      
      var { data: urlData } = sb.storage.from('item-photos').getPublicUrl(filePath);
      return urlData.publicUrl;
    }

    async function saveItem() {
      var desc = document.getElementById('itemDesc').value.trim();
      if (!desc) {
        alert('Please enter a description');
        return;
      }
      
      // Require photo for new items (not editing)
      if (!editingItemId && !selectedPhotoFile) {
        alert('Please upload a photo of the item');
        return;
      }
      
      var btn = document.getElementById('saveItemBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      try {
        var photoUrl = null;
        
        // Upload photo if selected
        if (selectedPhotoFile) {
          var tempId = editingItemId || ('INV-' + Date.now());
          photoUrl = await uploadPhoto(selectedPhotoFile, tempId);
        }
        
        if (editingItemId) {
          // Update existing item
          var updateData = {
            description: desc,
            category: document.getElementById('itemCategory').value,
            quantity: parseInt(document.getElementById('itemQty').value) || 1,
            weight: parseFloat(document.getElementById('itemWeight').value) || 0,
            value: parseFloat(document.getElementById('itemValue').value) || 0,
            notes: document.getElementById('itemNotes').value
          };
          
          if (photoUrl) {
            updateData.photo_url = photoUrl;
          }
          
          var { data, error } = await sb.from('inventory').update(updateData).eq('id', editingItemId).select();
          if (error) throw error;
          
          // Update local state
          var idx = inventory.findIndex(function(i) { return i.id === editingItemId; });
          if (idx !== -1) {
            inventory[idx] = data[0];
          }
        } else {
          // Create new item
          var item = {
            item_id: 'INV-' + Date.now(),
            description: desc,
            category: document.getElementById('itemCategory').value,
            quantity: parseInt(document.getElementById('itemQty').value) || 1,
            weight: parseFloat(document.getElementById('itemWeight').value) || 0,
            value: parseFloat(document.getElementById('itemValue').value) || 0,
            notes: document.getElementById('itemNotes').value,
            status: 'received',
            user_id: currentUser.id,
            photo_url: photoUrl
          };
          
          // Admin can assign to different customer
          if (userRole === 'admin') {
            var selectedCustomer = document.getElementById('itemCustomer').value;
            if (selectedCustomer) {
              item.user_id = selectedCustomer;
            }
          }
          
          var { data, error } = await sb.from('inventory').insert([item]).select();
          if (error) throw error;
          
          inventory.unshift(data[0]);
        }
        
        closeModal('itemModal');
        clearItemForm();
        renderAll();
      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = editingItemId ? 'Save Changes' : 'Add Item';
      }
    }

    function editItem(id) {
      var item = inventory.find(function(i) { return i.id === id; });
      if (!item) return;
      
      // Check if item can be edited (not submitted)
      if (item.status === 'submitted' && userRole !== 'admin') {
        alert('Cannot edit submitted items');
        return;
      }
      
      editingItemId = id;
      document.getElementById('itemModalTitle').textContent = 'Edit Item';
      document.getElementById('saveItemBtn').textContent = 'Save Changes';
      
      // Fill form with item data
      document.getElementById('itemDesc').value = item.description || '';
      document.getElementById('itemCategory').value = item.category || 'electronics';
      document.getElementById('itemQty').value = item.quantity || 1;
      document.getElementById('itemWeight').value = item.weight || 0;
      document.getElementById('itemValue').value = item.value || 0;
      document.getElementById('itemNotes').value = item.notes || '';
      
      // Show current photo if exists
      if (item.photo_url) {
        document.getElementById('currentPhotoImg').src = item.photo_url;
        document.getElementById('currentPhoto').style.display = 'block';
      } else {
        document.getElementById('currentPhoto').style.display = 'none';
      }
      
      openModal('itemModal');
    }

    function deleteItem(id) {
      if (!confirm('Delete this item?')) return;
      
      sb.from('inventory').delete().eq('id', id).then(function(r) {
        if (r.error) {
          alert('Error: ' + r.error.message);
          return;
        }
        inventory = inventory.filter(function(i) {
          return i.id !== id;
        });
        renderAll();
      });
    }

    function submitInventory() {
      // Check if there are items to submit
      var pendingItems = inventory.filter(function(i) {
        return i.status !== 'submitted';
      });
      
      if (pendingItems.length === 0) {
        alert('No items to submit');
        return;
      }
      
      if (!confirm('Are you sure you want to submit your inventory? You will not be able to delete items after submission.')) {
        return;
      }
      
      // Get IDs of items to update
      var itemIds = pendingItems.map(function(i) { return i.id; });
      
      // Update all items to 'submitted' status
      sb.from('inventory').update({status: 'submitted'}).in('id', itemIds).then(function(r) {
        if (r.error) {
          alert('Error submitting inventory: ' + r.error.message);
          return;
        }
        
        // Update local state
        inventory.forEach(function(item) {
          if (itemIds.indexOf(item.id) !== -1) {
            item.status = 'submitted';
          }
        });
        
        alert('Inventory submitted successfully!');
        renderAll();
      });
    }

    function clearItemForm() {
      document.getElementById('itemDesc').value = '';
      document.getElementById('itemQty').value = '1';
      document.getElementById('itemWeight').value = '0';
      document.getElementById('itemValue').value = '0';
      document.getElementById('itemNotes').value = '';
      document.getElementById('itemPhoto').value = '';
      document.getElementById('photoPreview').style.display = 'none';
      document.getElementById('photoPreviewImg').src = '';
      document.getElementById('currentPhoto').style.display = 'none';
      document.getElementById('currentPhotoImg').src = '';
      document.getElementById('itemModalTitle').textContent = 'Add Item';
      document.getElementById('saveItemBtn').textContent = 'Add Item';
      editingItemId = null;
      selectedPhotoFile = null;
    }

    // ==================== RENDERING ====================
    function getCustomerStats() {
      var stats = {};
      inventory.forEach(function(item) {
        var cid = item.user_id;
        if (!stats[cid]) stats[cid] = {items: 0, weight: 0, value: 0};
        stats[cid].items++;
        stats[cid].weight += item.weight || 0;
        stats[cid].value += item.value || 0;
      });
      return stats;
    }

    function renderAll() {
      if (userRole === 'admin') {
        renderAdminInterface();
      } else {
        renderCustomerInterface();
      }
    }

    // ==================== ADMIN RENDERING ====================
    function renderAdminInterface() {
      var stats = getCustomerStats();
      var totalWeight = 0;
      var totalValue = 0;
      var pendingCount = 0;
      var submittedCount = 0;
      
      inventory.forEach(function(item) {
        totalWeight += item.weight || 0;
        totalValue += item.value || 0;
        if (item.status === 'submitted') {
          submittedCount++;
        } else {
          pendingCount++;
        }
      });
      
      // Filter out admin users from customer count
      var customerList = customers.filter(function(c) { return c.role !== 'admin'; });
      var unsignedCount = customerList.filter(function(c) { return (c.docs_count || 0) < 3; }).length;
      
      // Update admin stats
      document.getElementById('adminStatWeight').textContent = totalWeight.toFixed(1) + ' lbs';
      document.getElementById('adminStatCustomers').textContent = customerList.length;
      document.getElementById('adminStatValue').textContent = '$' + totalValue.toLocaleString();
      document.getElementById('adminStatItems').textContent = inventory.length;
      document.getElementById('adminStatPending').textContent = pendingCount;
      document.getElementById('adminStatSubmitted').textContent = submittedCount;
      document.getElementById('adminStatUnsigned').textContent = unsignedCount;
      
      // Update nav badges
      document.getElementById('adminCustomerCount').textContent = customerList.length;
      document.getElementById('adminInventoryCount').textContent = inventory.length;
      
      // Render admin tables
      renderAdminRecentCustomers(stats);
      renderAdminRecentItems();
      renderAdminCustomers();
      renderAdminInventory();
      populateAdminDropdowns();
    }

    function renderAdminRecentCustomers(stats) {
      var customerList = customers.filter(function(c) { return c.role !== 'admin'; }).slice(0, 5);
      var html = '';
      
      customerList.forEach(function(c) {
        var s = stats[c.id] || {items: 0, weight: 0, value: 0};
        var initials = ((c.full_name || 'U')[0]).toUpperCase();
        var customerItems = inventory.filter(function(i) { return i.user_id === c.id; });
        var allSubmitted = customerItems.length > 0 && customerItems.every(function(i) { return i.status === 'submitted'; });
        var statusBadge = customerItems.length === 0 
          ? '<span class="status-badge" style="background:#eee;color:#666">No Items</span>'
          : (allSubmitted 
            ? '<span class="status-badge received">Submitted</span>'
            : '<span class="status-badge" style="background:var(--accent);color:#fff">Pending</span>');
        
        html += '<tr style="cursor:pointer" onclick="viewAdminCustomer(\'' + c.id + '\')">';
        html += '<td><div class="customer-cell"><div class="customer-avatar">' + initials + '</div>';
        html += '<div class="customer-info"><div class="name">' + (c.full_name || 'Unknown') + '</div>';
        html += '<div class="id">' + c.id.substring(0, 8) + '</div></div></div></td>';
        html += '<td>' + (c.email || '-') + '</td>';
        html += '<td>' + s.items + '</td>';
        html += '<td class="weight-cell">' + s.weight.toFixed(1) + ' lbs</td>';
        html += '<td class="value-cell">$' + s.value.toLocaleString() + '</td>';
        html += '<td>' + statusBadge + '</td>';
        html += '<td><button class="action-btn" onclick="event.stopPropagation();viewAdminCustomer(\'' + c.id + '\')">View</button></td>';
        html += '</tr>';
      });
      
      document.getElementById('adminRecentCustomersTable').innerHTML = html || '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No customers yet</td></tr>';
    }

    function renderAdminRecentItems() {
      var recentItems = inventory.slice(0, 5);
      var html = '';
      
      recentItems.forEach(function(item) {
        var customer = customers.find(function(c) { return c.id === item.user_id; });
        var date = item.created_at ? new Date(item.created_at).toLocaleDateString() : '-';
        var statusBadge = item.status === 'submitted'
          ? '<span class="status-badge received">Submitted</span>'
          : '<span class="status-badge" style="background:var(--accent);color:#fff">Pending</span>';
        
        html += '<tr>';
        html += '<td>' + date + '</td>';
        html += '<td>' + (customer ? customer.full_name : 'Unknown') + '</td>';
        html += '<td>' + item.description + '</td>';
        html += '<td class="weight-cell">' + (item.weight || 0) + ' lbs</td>';
        html += '<td class="value-cell">$' + (item.value || 0).toLocaleString() + '</td>';
        html += '<td>' + statusBadge + '</td>';
        html += '</tr>';
      });
      
      document.getElementById('adminRecentItemsTable').innerHTML = html || '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted)">No items yet</td></tr>';
    }

    function renderAdminCustomers() {
      var searchTerm = (document.getElementById('adminCustomerSearch').value || '').toLowerCase();
      var filter = document.getElementById('adminCustomerFilter').value;
      var stats = getCustomerStats();
      
      var customerList = customers.filter(function(c) {
        if (c.role === 'admin') return false;
        
        // Search filter
        if (searchTerm) {
          var match = (c.full_name || '').toLowerCase().includes(searchTerm) ||
                     (c.email || '').toLowerCase().includes(searchTerm) ||
                     (c.phone || '').toLowerCase().includes(searchTerm);
          if (!match) return false;
        }
        
        // Status filter
        var customerItems = inventory.filter(function(i) { return i.user_id === c.id; });
        var allSubmitted = customerItems.length > 0 && customerItems.every(function(i) { return i.status === 'submitted'; });
        
        if (filter === 'with-items') return customerItems.length > 0;
        if (filter === 'no-items') return customerItems.length === 0;
        if (filter === 'pending') return customerItems.length > 0 && !allSubmitted;
        if (filter === 'submitted') return allSubmitted;
        if (filter === 'unsigned') return (c.docs_count || 0) < 3;
        
        return true;
      });
      
      var html = '';
      customerList.forEach(function(c) {
        var s = stats[c.id] || {items: 0, weight: 0, value: 0};
        var initials = ((c.full_name || 'U')[0]).toUpperCase();
        var docsBadge = c.docs_count >= 3
          ? '<span class="status-badge received">' + c.docs_count + '/3</span>'
          : '<span class="status-badge" style="background:var(--danger-light);color:var(--danger)">' + (c.docs_count || 0) + '/3</span>';
        
        var customerItems = inventory.filter(function(i) { return i.user_id === c.id; });
        var allSubmitted = customerItems.length > 0 && customerItems.every(function(i) { return i.status === 'submitted'; });
        var statusBadge = customerItems.length === 0 
          ? '<span class="status-badge" style="background:#eee;color:#666">No Items</span>'
          : (allSubmitted 
            ? '<span class="status-badge received">Submitted</span>'
            : '<span class="status-badge" style="background:var(--accent);color:#fff">Pending</span>');
        
        html += '<tr style="cursor:pointer" onclick="viewAdminCustomer(\'' + c.id + '\')">';
        html += '<td><div class="customer-cell"><div class="customer-avatar">' + initials + '</div>';
        html += '<div class="customer-info"><div class="name">' + (c.full_name || 'Unknown') + '</div>';
        html += '<div class="id">' + c.id.substring(0, 8) + '</div></div></div></td>';
        html += '<td>' + (c.phone || '-') + '</td>';
        html += '<td>' + (c.email || '-') + '</td>';
        html += '<td>' + s.items + '</td>';
        html += '<td class="weight-cell">' + s.weight.toFixed(1) + ' lbs</td>';
        html += '<td class="value-cell">$' + s.value.toLocaleString() + '</td>';
        html += '<td>' + docsBadge + '</td>';
        html += '<td>' + statusBadge + '</td>';
        html += '<td><button class="action-btn" onclick="event.stopPropagation();viewAdminCustomer(\'' + c.id + '\')">View</button></td>';
        html += '</tr>';
      });
      
      document.getElementById('adminCustomersTable').innerHTML = html || '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted)">No customers match filter</td></tr>';
    }

    var selectedCustomerId = null;

    function viewAdminCustomer(customerId) {
      selectedCustomerId = customerId;
      var customer = customers.find(function(c) { return c.id === customerId; });
      if (!customer) return;
      
      // Navigate to customers page
      navigateTo('adminCustomers');
      
      var customerItems = inventory.filter(function(i) { return i.user_id === customerId; });
      var totalWeight = 0;
      var totalValue = 0;
      customerItems.forEach(function(i) { totalWeight += i.weight || 0; totalValue += i.value || 0; });
      
      // Update detail panel
      document.getElementById('adminDetailName').textContent = customer.full_name || 'Unknown';
      document.getElementById('adminDetailEmail').textContent = customer.email || '-';
      document.getElementById('adminDetailPhone').textContent = customer.phone || '-';
      document.getElementById('adminDetailSignup').textContent = customer.created_at ? new Date(customer.created_at).toLocaleDateString() : '-';
      document.getElementById('adminDetailDocs').textContent = (customer.docs_count || 0) + '/3 signed';
      document.getElementById('adminDetailWeight').textContent = totalWeight.toFixed(1) + ' lbs';
      document.getElementById('adminDetailValue').textContent = '$' + totalValue.toLocaleString();
      
      // Render customer items
      var html = '';
      customerItems.forEach(function(item) {
        var photoHtml = item.photo_url 
          ? '<img src="' + item.photo_url + '" style="width:40px;height:40px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="event.stopPropagation();viewPhoto(\'' + item.photo_url + '\')">'
          : '<span style="color:var(--text-muted);font-size:11px">No photo</span>';
        var statusBadge = item.status === 'submitted'
          ? '<span class="status-badge received">Submitted</span>'
          : '<span class="status-badge" style="background:var(--accent);color:#fff">Pending</span>';
        
        html += '<tr>';
        html += '<td style="font-family:monospace;font-size:11px">' + item.item_id + '</td>';
        html += '<td>' + photoHtml + '</td>';
        html += '<td>' + item.description + '</td>';
        html += '<td style="text-transform:capitalize">' + item.category + '</td>';
        html += '<td>' + (item.quantity || 1) + '</td>';
        html += '<td class="weight-cell">' + (item.weight || 0) + ' lbs</td>';
        html += '<td class="value-cell">$' + (item.value || 0).toLocaleString() + '</td>';
        html += '<td>' + statusBadge + '</td>';
        html += '<td><button class="action-btn" onclick="editItem(' + item.id + ')">Edit</button> <button class="action-btn danger" onclick="deleteItem(' + item.id + ')">Del</button></td>';
        html += '</tr>';
      });
      
      document.getElementById('adminCustomerItemsTable').innerHTML = html || '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted)">No items</td></tr>';
      
      // Show detail panel
      document.getElementById('adminCustomerDetail').style.display = 'block';
      document.getElementById('adminCustomerDetail').scrollIntoView({ behavior: 'smooth' });
    }

    function closeAdminCustomerDetail() {
      document.getElementById('adminCustomerDetail').style.display = 'none';
      selectedCustomerId = null;
    }

    function addItemForSelectedCustomer() {
      if (!selectedCustomerId) return;
      document.getElementById('itemCustomer').value = selectedCustomerId;
      openModal('itemModal');
    }

    function renderAdminInventory() {
      var customerFilter = document.getElementById('adminInvCustomerFilter').value;
      var categoryFilter = document.getElementById('adminInvCategoryFilter').value;
      var statusFilter = document.getElementById('adminInvStatusFilter').value;
      
      var filtered = inventory.filter(function(item) {
        if (customerFilter && item.user_id !== customerFilter) return false;
        if (categoryFilter && item.category !== categoryFilter) return false;
        if (statusFilter && item.status !== statusFilter) return false;
        return true;
      });
      
      var html = '';
      var totalWeight = 0;
      var totalValue = 0;
      
      filtered.forEach(function(item) {
        var customer = customers.find(function(c) { return c.id === item.user_id; });
        var photoHtml = item.photo_url 
          ? '<img src="' + item.photo_url + '" style="width:40px;height:40px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="viewPhoto(\'' + item.photo_url + '\')">'
          : '<span style="color:var(--text-muted);font-size:11px">No photo</span>';
        var statusBadge = item.status === 'submitted'
          ? '<span class="status-badge received">Submitted</span>'
          : '<span class="status-badge" style="background:var(--accent);color:#fff">Pending</span>';
        
        html += '<tr>';
        html += '<td style="font-family:monospace;font-size:11px">' + item.item_id + '</td>';
        html += '<td>' + (customer ? customer.full_name : 'Unknown') + '</td>';
        html += '<td>' + photoHtml + '</td>';
        html += '<td>' + item.description + '</td>';
        html += '<td style="text-transform:capitalize">' + item.category + '</td>';
        html += '<td class="weight-cell">' + (item.weight || 0) + ' lbs</td>';
        html += '<td class="value-cell">$' + (item.value || 0).toLocaleString() + '</td>';
        html += '<td>' + statusBadge + '</td>';
        html += '<td><button class="action-btn" onclick="editItem(' + item.id + ')">Edit</button> <button class="action-btn danger" onclick="deleteItem(' + item.id + ')">Del</button></td>';
        html += '</tr>';
        
        totalWeight += item.weight || 0;
        totalValue += item.value || 0;
      });
      
      document.getElementById('adminInventoryTable').innerHTML = html || '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted)">No items match filter</td></tr>';
      document.getElementById('adminInvTotalItems').textContent = filtered.length;
      document.getElementById('adminInvTotalWeight').textContent = totalWeight.toFixed(1) + ' lbs';
      document.getElementById('adminInvTotalValue').textContent = '$' + totalValue.toLocaleString();
    }

    function populateAdminDropdowns() {
      var customerList = customers.filter(function(c) { return c.role !== 'admin'; });
      var opts = '<option value="">All Customers</option>';
      customerList.forEach(function(c) {
        opts += '<option value="' + c.id + '">' + (c.full_name || 'Unknown') + '</option>';
      });
      document.getElementById('adminInvCustomerFilter').innerHTML = opts;
      
      // Also populate the item modal customer dropdown
      var modalOpts = '<option value="">Select Customer...</option>';
      customerList.forEach(function(c) {
        modalOpts += '<option value="' + c.id + '">' + (c.full_name || 'Unknown') + '</option>';
      });
      document.getElementById('itemCustomer').innerHTML = modalOpts;
    }

    // ==================== CUSTOMER RENDERING ====================
    function renderCustomerInterface() {
      var totalWeight = 0;
      var totalValue = 0;
      var pendingCount = 0;
      
      inventory.forEach(function(item) {
        totalWeight += item.weight || 0;
        totalValue += item.value || 0;
        if (item.status !== 'submitted') pendingCount++;
      });
      
      var allSubmitted = inventory.length > 0 && inventory.every(function(i) { return i.status === 'submitted'; });
      var statusText = inventory.length === 0 ? 'No Items' : (allSubmitted ? 'Submitted' : 'Pending');
      
      // Update customer stats
      document.getElementById('customerStatWeight').textContent = totalWeight.toFixed(1) + ' lbs';
      document.getElementById('customerStatItems').textContent = inventory.length;
      document.getElementById('customerStatValue').textContent = '$' + totalValue.toLocaleString();
      document.getElementById('customerStatStatus').textContent = statusText;
      
      // Update nav badge
      document.getElementById('customerInventoryCount').textContent = inventory.length;
      
      // Show/hide submit button
      document.getElementById('customerSubmitBtn').style.display = pendingCount > 0 ? '' : 'none';
      
      // Render customer tables
      renderCustomerRecentItems();
      renderCustomerInventoryTable();
    }

    function renderCustomerRecentItems() {
      var recentItems = inventory.slice(0, 5);
      var html = '';
      
      recentItems.forEach(function(item) {
        var photoHtml = item.photo_url 
          ? '<img src="' + item.photo_url + '" style="width:40px;height:40px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="viewPhoto(\'' + item.photo_url + '\')">'
          : '<span style="color:var(--text-muted);font-size:11px">No photo</span>';
        var statusBadge = item.status === 'submitted'
          ? '<span class="status-badge received">Submitted</span>'
          : '<span class="status-badge" style="background:var(--accent);color:#fff">Pending</span>';
        var actionBtn = item.status !== 'submitted'
          ? '<button class="action-btn" onclick="editItem(' + item.id + ')">Edit</button>'
          : '<span style="color:var(--text-muted);font-size:11px">Locked</span>';
        
        html += '<tr>';
        html += '<td style="font-family:monospace;font-size:11px">' + item.item_id + '</td>';
        html += '<td>' + photoHtml + '</td>';
        html += '<td>' + item.description + '</td>';
        html += '<td class="weight-cell">' + (item.weight || 0) + ' lbs</td>';
        html += '<td class="value-cell">$' + (item.value || 0).toLocaleString() + '</td>';
        html += '<td>' + statusBadge + '</td>';
        html += '<td>' + actionBtn + '</td>';
        html += '</tr>';
      });
      
      document.getElementById('customerRecentItemsTable').innerHTML = html || '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No items yet. Click "Add Item" to get started!</td></tr>';
    }

    function renderCustomerInventoryTable() {
      var html = '';
      var totalWeight = 0;
      var totalValue = 0;
      
      inventory.forEach(function(item) {
        var photoHtml = item.photo_url 
          ? '<img src="' + item.photo_url + '" style="width:40px;height:40px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="viewPhoto(\'' + item.photo_url + '\')">'
          : '<span style="color:var(--text-muted);font-size:11px">No photo</span>';
        var statusBadge = item.status === 'submitted'
          ? '<span class="status-badge received">Submitted</span>'
          : '<span class="status-badge" style="background:var(--accent);color:#fff">Pending</span>';
        
        var actionBtns = '';
        if (item.status !== 'submitted') {
          actionBtns = '<button class="action-btn" onclick="editItem(' + item.id + ')">Edit</button> <button class="action-btn danger" onclick="deleteItem(' + item.id + ')">Del</button>';
        } else {
          actionBtns = '<span style="color:var(--text-muted);font-size:11px">Locked</span>';
        }
        
        html += '<tr>';
        html += '<td style="font-family:monospace;font-size:11px">' + item.item_id + '</td>';
        html += '<td>' + photoHtml + '</td>';
        html += '<td>' + item.description + '</td>';
        html += '<td style="text-transform:capitalize">' + item.category + '</td>';
        html += '<td class="weight-cell">' + (item.weight || 0) + ' lbs</td>';
        html += '<td class="value-cell">$' + (item.value || 0).toLocaleString() + '</td>';
        html += '<td>' + statusBadge + '</td>';
        html += '<td>' + actionBtns + '</td>';
        html += '</tr>';
        
        totalWeight += item.weight || 0;
        totalValue += item.value || 0;
      });
      
      document.getElementById('customerInventoryTable').innerHTML = html || '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted)">No items yet</td></tr>';
      document.getElementById('customerInvTotalItems').textContent = inventory.length;
      document.getElementById('customerInvTotalWeight').textContent = totalWeight.toFixed(1) + ' lbs';
      document.getElementById('customerInvTotalValue').textContent = '$' + totalValue.toLocaleString();
    }

    function renderDocs() {
      var html = '';
      signedDocs.forEach(function(doc) {
        var date = new Date(doc.signed_at).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'});
        html += '<tr>';
        html += '<td>' + doc.doc_title + '</td>';
        html += '<td>' + date + '</td>';
        html += '<td style="font-family:monospace;font-style:italic">' + doc.signature + '</td>';
        html += '<td><button class="action-btn" onclick="downloadDoc(\'' + doc.doc_type + '\',\'' + doc.doc_title + '\',\'' + doc.signature + '\',\'' + doc.signed_at + '\')">Download</button></td>';
        html += '</tr>';
      });
      
      document.getElementById('customerDocsTable').innerHTML = html || '<tr><td colspan="4" style="text-align:center;padding:40px;color:var(--text-muted)">No documents</td></tr>';
    }

    function viewPhoto(url) {
      window.open(url, '_blank');
    }

    function refreshData() {
      loadData();
    }

    // ==================== NAVIGATION ====================
    function navigateTo(pageId) {
      document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
      document.getElementById(pageId).classList.add('active');
      
      // Update nav
      var navSection = userRole === 'admin' ? '#adminNav' : '#customerNav';
      document.querySelectorAll(navSection + ' .nav-item').forEach(function(n) { n.classList.remove('active'); });
      var navItem = document.querySelector(navSection + ' .nav-item[data-page="' + pageId + '"]');
      if (navItem) navItem.classList.add('active');
      
      // Close mobile menu
      if (window.innerWidth <= 768 && typeof toggleMobileMenu === 'function') {
        var sidebar = document.querySelector('.sidebar');
        if (sidebar.classList.contains('open')) {
          toggleMobileMenu();
        }
      }
    }

    function populateDropdowns() {
      // This is kept for backwards compatibility but main dropdowns are in populateAdminDropdowns
    }

    // ==================== MODALS ====================
    function openModal(id) {
      document.getElementById(id).classList.add('active');
      // Populate customer dropdown if admin
      if (userRole === 'admin') {
        populateAdminDropdowns();
      }
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
      clearItemForm();
    }

    // ==================== NAVIGATION EVENT LISTENERS ====================
    document.querySelectorAll('.nav-item').forEach(function(item) {
      item.addEventListener('click', function() {
        var page = this.getAttribute('data-page');
        if (!page) return;
        navigateTo(page);
      });
    });

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(function(m) {
      m.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
          clearItemForm();
        }
      });
    });

    function downloadDoc(type, title, sig, date) {
      var content = 'GUINEA CARGO SERVICES\n';
      content += '========================\n\n';
      content += 'Document: ' + title + '\n';
      content += 'Signed By: ' + sig + '\n';
      content += 'Date: ' + new Date(date).toLocaleDateString() + '\n';
      content += 'User: ' + currentUser.email + '\n\n';
      content += 'This document was electronically signed.\n';
      
      var blob = new Blob([content], {type: 'text/plain'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = type + '_signed.txt';
      a.click();
    }

    // ==================== EXPORT ====================
    function exportCSV() {
      var csv = 'ID,Customer,Description,Category,Qty,Weight,Value,Status,Photo URL\n';
      inventory.forEach(function(item) {
        var customer = customers.find(function(c) { return c.id === item.user_id; });
        csv += item.item_id + ',"' + (customer ? customer.full_name : '') + '","' + item.description + '",' + item.category + ',' + (item.quantity || 1) + ',' + item.weight + ',' + item.value + ',' + item.status + ',' + (item.photo_url || '') + '\n';
      });
      
      var blob = new Blob([csv], {type: 'text/csv'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'inventory_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
    }

    function exportAllData() {
      // Export complete data including customers and items
      var csv = 'CUSTOMERS\n';
      csv += 'Name,Email,Phone,Docs Signed,Items,Total Weight,Total Value\n';
      
      var stats = getCustomerStats();
      customers.forEach(function(c) {
        if (c.role === 'admin') return;
        var s = stats[c.id] || {items: 0, weight: 0, value: 0};
        csv += '"' + (c.full_name || '') + '",' + (c.email || '') + ',' + (c.phone || '') + ',' + (c.docs_count || 0) + ',' + s.items + ',' + s.weight.toFixed(1) + ',' + s.value.toFixed(2) + '\n';
      });
      
      csv += '\nINVENTORY\n';
      csv += 'ID,Customer,Description,Category,Qty,Weight,Value,Status,Created\n';
      inventory.forEach(function(item) {
        var customer = customers.find(function(c) { return c.id === item.user_id; });
        var date = item.created_at ? new Date(item.created_at).toLocaleDateString() : '';
        csv += item.item_id + ',"' + (customer ? customer.full_name : '') + '","' + item.description + '",' + item.category + ',' + (item.quantity || 1) + ',' + item.weight + ',' + item.value + ',' + item.status + ',' + date + '\n';
      });
      
      // Totals
      var totalWeight = 0, totalValue = 0;
      inventory.forEach(function(i) { totalWeight += i.weight || 0; totalValue += i.value || 0; });
      csv += '\nSUMMARY\n';
      csv += 'Total Customers,' + customers.filter(function(c) { return c.role !== 'admin'; }).length + '\n';
      csv += 'Total Items,' + inventory.length + '\n';
      csv += 'Total Weight,' + totalWeight.toFixed(1) + ' lbs\n';
      csv += 'Total Value,$' + totalValue.toFixed(2) + '\n';
      
      var blob = new Blob([csv], {type: 'text/csv'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'gcs_export_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
    }

    function exportCustomers() {
      var csv = 'Name,Email,Phone,Docs Signed,Items,Total Weight,Total Value,Status\n';
      var stats = getCustomerStats();
      
      customers.forEach(function(c) {
        if (c.role === 'admin') return;
        var s = stats[c.id] || {items: 0, weight: 0, value: 0};
        var customerItems = inventory.filter(function(i) { return i.user_id === c.id; });
        var allSubmitted = customerItems.length > 0 && customerItems.every(function(i) { return i.status === 'submitted'; });
        var status = customerItems.length === 0 ? 'No Items' : (allSubmitted ? 'Submitted' : 'Pending');
        csv += '"' + (c.full_name || '') + '",' + (c.email || '') + ',' + (c.phone || '') + ',' + (c.docs_count || 0) + ',' + s.items + ',' + s.weight.toFixed(1) + ',' + s.value.toFixed(2) + ',' + status + '\n';
      });
      
      var blob = new Blob([csv], {type: 'text/csv'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'customers_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
    }

    function exportSubmitted() {
      var submittedItems = inventory.filter(function(i) { return i.status === 'submitted'; });
      var csv = 'ID,Customer,Description,Category,Qty,Weight,Value\n';
      
      submittedItems.forEach(function(item) {
        var customer = customers.find(function(c) { return c.id === item.user_id; });
        csv += item.item_id + ',"' + (customer ? customer.full_name : '') + '","' + item.description + '",' + item.category + ',' + (item.quantity || 1) + ',' + item.weight + ',' + item.value + '\n';
      });
      
      var totalWeight = 0, totalValue = 0;
      submittedItems.forEach(function(i) { totalWeight += i.weight || 0; totalValue += i.value || 0; });
      csv += '\nTOTAL,,' + submittedItems.length + ' items,,' + totalWeight.toFixed(1) + ' lbs,$' + totalValue.toFixed(2) + '\n';
      
      var blob = new Blob([csv], {type: 'text/csv'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'submitted_items_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
    }

    function addItemForCustomer() {
      if (!selectedCustomerId) return;
      document.getElementById('itemCustomer').value = selectedCustomerId;
      openModal('itemModal');
    }

    // ==================== SHIPMENTS ====================
    function renderShipments() {
      var html = '';
      
      shipments.forEach(function(shipment) {
        var shipmentItems = inventory.filter(function(i) { return i.shipment_id === shipment.id; });
        var totalWeight = 0, totalValue = 0;
        shipmentItems.forEach(function(i) { totalWeight += i.weight || 0; totalValue += i.value || 0; });
        
        var statusColors = {
          planning: 'background:var(--accent);color:#000',
          loading: 'background:#3b82f6;color:#fff',
          shipped: 'background:#8b5cf6;color:#fff',
          delivered: 'background:var(--success);color:#fff'
        };
        var statusStyle = statusColors[shipment.status] || statusColors.planning;
        
        var date = shipment.target_date ? new Date(shipment.target_date).toLocaleDateString() : '-';
        
        html += '<tr style="cursor:pointer" onclick="viewShipment(' + shipment.id + ')">';
        html += '<td style="font-family:monospace;font-size:12px">SHP-' + String(shipment.id).padStart(3, '0') + '</td>';
        html += '<td><strong>' + (shipment.name || 'Unnamed') + '</strong></td>';
        html += '<td>' + date + '</td>';
        html += '<td>' + shipmentItems.length + '</td>';
        html += '<td class="weight-cell">' + totalWeight.toFixed(1) + ' lbs</td>';
        html += '<td class="value-cell">$' + totalValue.toLocaleString() + '</td>';
        html += '<td><span class="status-badge" style="' + statusStyle + ';text-transform:capitalize">' + shipment.status + '</span></td>';
        html += '<td><button class="action-btn" onclick="event.stopPropagation();viewShipment(' + shipment.id + ')">View</button> <button class="action-btn danger" onclick="event.stopPropagation();deleteShipment(' + shipment.id + ')">Del</button></td>';
        html += '</tr>';
      });
      
      document.getElementById('shipmentsTable').innerHTML = html || '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted)">No shipments yet. Click "New Shipment" to create one.</td></tr>';
      document.getElementById('adminShipmentCount').textContent = shipments.length;
    }

    function saveShipment() {
      var name = document.getElementById('shipmentName').value.trim();
      if (!name) {
        alert('Please enter a shipment name');
        return;
      }
      
      var shipmentData = {
        name: name,
        target_date: document.getElementById('shipmentDate').value || null,
        status: document.getElementById('shipmentStatus').value,
        notes: document.getElementById('shipmentNotes').value.trim()
      };
      
      sb.from('shipments').insert([shipmentData]).select().then(function(r) {
        if (r.error) {
          alert('Error creating shipment: ' + r.error.message);
          return;
        }
        
        shipments.unshift(r.data[0]);
        renderShipments();
        closeModal('shipmentModal');
        
        // Clear form
        document.getElementById('shipmentName').value = '';
        document.getElementById('shipmentDate').value = '';
        document.getElementById('shipmentStatus').value = 'planning';
        document.getElementById('shipmentNotes').value = '';
        
        // View the new shipment
        viewShipment(r.data[0].id);
      });
    }

    function viewShipment(shipmentId) {
      currentShipmentId = shipmentId;
      var shipment = shipments.find(function(s) { return s.id === shipmentId; });
      if (!shipment) return;
      
      // Navigate to shipments page
      navigateTo('adminShipments');
      
      var shipmentItems = inventory.filter(function(i) { return i.shipment_id === shipmentId; });
      var totalWeight = 0, totalValue = 0;
      shipmentItems.forEach(function(i) { totalWeight += i.weight || 0; totalValue += i.value || 0; });
      
      // Update header
      document.getElementById('shipmentDetailName').textContent = shipment.name || 'Unnamed Shipment';
      document.getElementById('shipmentDetailId').textContent = 'SHP-' + String(shipment.id).padStart(3, '0');
      document.getElementById('shipmentDetailDate').textContent = shipment.target_date ? new Date(shipment.target_date).toLocaleDateString() : '-';
      document.getElementById('shipmentDetailStatus').textContent = (shipment.status || 'planning').charAt(0).toUpperCase() + (shipment.status || 'planning').slice(1);
      document.getElementById('shipmentDetailItems').textContent = shipmentItems.length;
      document.getElementById('shipmentDetailWeight').textContent = totalWeight.toFixed(1) + ' lbs';
      document.getElementById('shipmentDetailValue').textContent = '$' + totalValue.toLocaleString();
      document.getElementById('shipmentDetailNotes').textContent = shipment.notes || 'No notes';
      
      // Render items table
      var html = '';
      shipmentItems.forEach(function(item) {
        var customer = customers.find(function(c) { return c.id === item.user_id; });
        html += '<tr>';
        html += '<td><input type="checkbox" class="shipment-item-checkbox" value="' + item.id + '"></td>';
        html += '<td style="font-family:monospace;font-size:11px">' + item.item_id + '</td>';
        html += '<td>' + (customer ? customer.full_name : 'Unknown') + '</td>';
        html += '<td>' + item.description + '</td>';
        html += '<td class="weight-cell">' + (item.weight || 0) + ' lbs</td>';
        html += '<td class="value-cell">$' + (item.value || 0).toLocaleString() + '</td>';
        html += '<td><button class="action-btn danger" onclick="removeFromShipment(' + item.id + ')">Remove</button></td>';
        html += '</tr>';
      });
      
      document.getElementById('shipmentItemsTable').innerHTML = html || '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No items in this shipment. Click "Add Items" to add inventory.</td></tr>';
      document.getElementById('shipmentTotalItems').textContent = shipmentItems.length;
      document.getElementById('shipmentTotalWeight').textContent = totalWeight.toFixed(1) + ' lbs';
      document.getElementById('shipmentTotalValue').textContent = '$' + totalValue.toLocaleString();
      
      // Show panel
      document.getElementById('shipmentDetailPanel').style.display = 'block';
      document.getElementById('shipmentDetailPanel').scrollIntoView({ behavior: 'smooth' });
    }

    function closeShipmentDetail() {
      document.getElementById('shipmentDetailPanel').style.display = 'none';
      currentShipmentId = null;
    }

    function deleteShipment(shipmentId) {
      if (!confirm('Delete this shipment? Items will be unassigned but not deleted.')) return;
      
      // First unassign all items
      sb.from('inventory').update({ shipment_id: null }).eq('shipment_id', shipmentId).then(function() {
        // Then delete shipment
        sb.from('shipments').delete().eq('id', shipmentId).then(function(r) {
          if (r.error) {
            alert('Error: ' + r.error.message);
            return;
          }
          
          // Update local inventory
          inventory.forEach(function(i) {
            if (i.shipment_id === shipmentId) i.shipment_id = null;
          });
          
          // Remove from shipments array
          shipments = shipments.filter(function(s) { return s.id !== shipmentId; });
          renderShipments();
          closeShipmentDetail();
        });
      });
    }

    function addItemsToShipment() {
      if (!currentShipmentId) return;
      
      // Populate customer filter
      var customerList = customers.filter(function(c) { return c.role !== 'admin'; });
      var opts = '<option value="">All Customers</option>';
      customerList.forEach(function(c) {
        opts += '<option value="' + c.id + '">' + (c.full_name || 'Unknown') + '</option>';
      });
      document.getElementById('addShipmentCustomerFilter').innerHTML = opts;
      
      renderAvailableItems();
      openModal('addToShipmentModal');
    }

    function renderAvailableItems() {
      var customerFilter = document.getElementById('addShipmentCustomerFilter').value;
      var statusFilter = document.getElementById('addShipmentStatusFilter').value;
      var hideAssigned = document.getElementById('hideAssignedItems').checked;
      
      var available = inventory.filter(function(item) {
        if (customerFilter && item.user_id !== customerFilter) return false;
        if (statusFilter && item.status !== statusFilter) return false;
        if (hideAssigned && item.shipment_id) return false;
        if (item.shipment_id === currentShipmentId) return false; // Already in this shipment
        return true;
      });
      
      var html = '';
      available.forEach(function(item) {
        var customer = customers.find(function(c) { return c.id === item.user_id; });
        var statusBadge = item.status === 'submitted'
          ? '<span class="status-badge received">Submitted</span>'
          : '<span class="status-badge" style="background:var(--accent);color:#fff">Pending</span>';
        var assignedBadge = item.shipment_id ? '<span style="color:var(--text-muted);font-size:10px;margin-left:4px">(assigned)</span>' : '';
        
        html += '<tr>';
        html += '<td><input type="checkbox" class="available-item-checkbox" value="' + item.id + '" onchange="updateSelectedCount()"></td>';
        html += '<td style="font-family:monospace;font-size:11px">' + item.item_id + '</td>';
        html += '<td>' + (customer ? customer.full_name : 'Unknown') + assignedBadge + '</td>';
        html += '<td>' + item.description + '</td>';
        html += '<td class="weight-cell">' + (item.weight || 0) + ' lbs</td>';
        html += '<td class="value-cell">$' + (item.value || 0).toLocaleString() + '</td>';
        html += '<td>' + statusBadge + '</td>';
        html += '</tr>';
      });
      
      document.getElementById('availableItemsTable').innerHTML = html || '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No available items match filter</td></tr>';
      document.getElementById('selectAllAvailable').checked = false;
      updateSelectedCount();
    }

    function toggleAllAvailable() {
      var checked = document.getElementById('selectAllAvailable').checked;
      document.querySelectorAll('.available-item-checkbox').forEach(function(cb) {
        cb.checked = checked;
      });
      updateSelectedCount();
    }

    function updateSelectedCount() {
      var count = document.querySelectorAll('.available-item-checkbox:checked').length;
      document.getElementById('selectedItemCount').textContent = count;
    }

    function confirmAddToShipment() {
      var itemIds = [];
      document.querySelectorAll('.available-item-checkbox:checked').forEach(function(cb) {
        itemIds.push(parseInt(cb.value));
      });
      
      if (itemIds.length === 0) {
        alert('Please select at least one item');
        return;
      }
      
      sb.from('inventory').update({ shipment_id: currentShipmentId }).in('id', itemIds).then(function(r) {
        if (r.error) {
          alert('Error: ' + r.error.message);
          return;
        }
        
        // Update local inventory
        inventory.forEach(function(item) {
          if (itemIds.indexOf(item.id) !== -1) {
            item.shipment_id = currentShipmentId;
          }
        });
        
        closeModal('addToShipmentModal');
        viewShipment(currentShipmentId);
        renderAdminInterface();
      });
    }

    function removeFromShipment(itemId) {
      sb.from('inventory').update({ shipment_id: null }).eq('id', itemId).then(function(r) {
        if (r.error) {
          alert('Error: ' + r.error.message);
          return;
        }
        
        // Update local inventory
        var item = inventory.find(function(i) { return i.id === itemId; });
        if (item) item.shipment_id = null;
        
        viewShipment(currentShipmentId);
      });
    }

    function toggleAllShipmentItems() {
      var checked = document.getElementById('selectAllShipmentItems').checked;
      document.querySelectorAll('.shipment-item-checkbox').forEach(function(cb) {
        cb.checked = checked;
      });
    }

    function removeSelectedFromShipment() {
      var itemIds = [];
      document.querySelectorAll('.shipment-item-checkbox:checked').forEach(function(cb) {
        itemIds.push(parseInt(cb.value));
      });
      
      if (itemIds.length === 0) {
        alert('Please select items to remove');
        return;
      }
      
      if (!confirm('Remove ' + itemIds.length + ' items from this shipment?')) return;
      
      sb.from('inventory').update({ shipment_id: null }).in('id', itemIds).then(function(r) {
        if (r.error) {
          alert('Error: ' + r.error.message);
          return;
        }
        
        // Update local inventory
        inventory.forEach(function(item) {
          if (itemIds.indexOf(item.id) !== -1) {
            item.shipment_id = null;
          }
        });
        
        viewShipment(currentShipmentId);
      });
    }

    function exportShipment() {
      if (!currentShipmentId) return;
      
      var shipment = shipments.find(function(s) { return s.id === currentShipmentId; });
      var shipmentItems = inventory.filter(function(i) { return i.shipment_id === currentShipmentId; });
      
      var csv = 'SHIPMENT: ' + (shipment.name || 'Unnamed') + '\n';
      csv += 'ID: SHP-' + String(shipment.id).padStart(3, '0') + '\n';
      csv += 'Date: ' + (shipment.target_date || '-') + '\n';
      csv += 'Status: ' + (shipment.status || 'planning') + '\n\n';
      csv += 'ITEMS\n';
      csv += 'Item ID,Customer,Description,Category,Weight,Value\n';
      
      var totalWeight = 0, totalValue = 0;
      shipmentItems.forEach(function(item) {
        var customer = customers.find(function(c) { return c.id === item.user_id; });
        csv += item.item_id + ',"' + (customer ? customer.full_name : '') + '","' + item.description + '",' + item.category + ',' + item.weight + ',' + item.value + '\n';
        totalWeight += item.weight || 0;
        totalValue += item.value || 0;
      });
      
      csv += '\nTOTAL,,' + shipmentItems.length + ' items,,' + totalWeight.toFixed(1) + ' lbs,$' + totalValue.toFixed(2) + '\n';
      
      var blob = new Blob([csv], {type: 'text/csv'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'shipment_' + (shipment.name || 'export').replace(/\s+/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
    }

    // ==================== MOBILE MENU ====================
    function toggleMobileMenu() {
      var sidebar = document.querySelector('.sidebar');
      var overlay = document.getElementById('sidebarOverlay');
      var btn = document.getElementById('mobileMenuBtn');
      
      if (sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        btn.textContent = 'â˜°';
      } else {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        btn.textContent = 'âœ•';
      }
    }

    // Close mobile menu when navigating
    document.querySelectorAll('.nav-item').forEach(function(item) {
      item.addEventListener('click', function() {
        if (window.innerWidth <= 768) {
          toggleMobileMenu();
        }
      });
    });

    // Hide mobile menu button when not in app
    function updateMobileMenuVisibility() {
      var btn = document.getElementById('mobileMenuBtn');
      var overlay = document.getElementById('sidebarOverlay');
      var appVisible = document.getElementById('appContainer').classList.contains('show');
      var isMobile = window.innerWidth <= 768;
      
      if (btn) {
        if (appVisible && isMobile) {
          btn.classList.add('visible');
        } else {
          btn.classList.remove('visible');
          // Also close sidebar when hiding button
          document.querySelector('.sidebar').classList.remove('open');
          if (overlay) overlay.classList.remove('active');
        }
      }
    }

    // Update on resize
    window.addEventListener('resize', function() {
      updateMobileMenuVisibility();
      // Close sidebar on resize to desktop
      if (window.innerWidth > 768) {
        document.querySelector('.sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('active

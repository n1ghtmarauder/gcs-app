<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GCS Operations | Guinea Cargo Services</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #1a5f4a;
      --primary-light: #238b6a;
      --primary-dark: #0f3d2f;
      --accent: #e8a838;
      --danger: #c44536;
      --danger-light: #f8d7d4;
      --success: #2e7d5a;
      --success-light: #d4edda;
      --warning: #e8a838;
      --warning-light: #fff3cd;
      --bg-dark: #0d1f1a;
      --bg-main: #f7f9f8;
      --bg-card: #ffffff;
      --text-primary: #1a2e28;
      --text-secondary: #5a6b65;
      --text-muted: #8a9a94;
      --border: #d8e0dc;
      --border-light: #e8eeeb;
      --shadow-sm: 0 1px 3px rgba(26,95,74,0.08);
      --shadow-md: 0 4px 12px rgba(26,95,74,0.1);
      --shadow-lg: 0 8px 30px rgba(26,95,74,0.12);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg-main); color: var(--text-primary); min-height: 100vh; }

    .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--bg-dark) 0%, var(--primary-dark) 100%); padding: 20px; }
    .login-container { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 100%; max-width: 420px; overflow: hidden; }
    .login-header { background: var(--bg-dark); padding: 32px; text-align: center; }
    .login-header h1 { font-size: 22px; color: #fff; margin-bottom: 4px; }
    .login-header h1 span { color: var(--accent); }
    .login-header p { color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .login-body { padding: 32px; }
    .login-tabs { display: flex; gap: 4px; background: var(--bg-main); padding: 4px; border-radius: var(--radius-md); margin-bottom: 24px; }
    .login-tab { flex: 1; padding: 10px; border: none; background: transparent; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; color: var(--text-secondary); cursor: pointer; font-family: inherit; }
    .login-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow-sm); }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
    .form-input { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; font-family: inherit; }
    .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,95,74,0.1); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border-radius: var(--radius-md); font-size: 14px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; width: 100%; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-light); }
    .btn-secondary { background: var(--bg-main); color: var(--text-primary); border: 1px solid var(--border); }
    .error-message { background: var(--danger-light); color: var(--danger); padding: 12px; border-radius: var(--radius-md); font-size: 13px; margin-bottom: 20px; display: none; }
    .error-message.show { display: block; }
    .success-message { background: var(--success-light); color: var(--success); padding: 12px; border-radius: var(--radius-md); font-size: 13px; margin-bottom: 20px; display: none; }
    .success-message.show { display: block; }
    .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .app-container { display: none; }
    .app-container.show { display: block; }
    .login-screen.hidden { display: none; }

    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: var(--bg-dark); padding: 24px 0; z-index: 100; display: flex; flex-direction: column; }
    .logo { padding: 20px 24px 28px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 24px; }
    .logo h1 { font-size: 20px; font-weight: 700; color: #fff; }
    .logo h1 span { color: var(--accent); }
    .logo p { font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
    .nav-section { padding: 0 12px; margin-bottom: 24px; }
    .nav-section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: rgba(255,255,255,0.35); padding: 0 12px 12px; font-weight: 600; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: rgba(255,255,255,0.7); text-decoration: none; border-radius: var(--radius-md); cursor: pointer; font-size: 14px; font-weight: 500; }
    .nav-item:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .nav-item.active { background: var(--primary); color: #fff; }
    .nav-item svg { width: 20px; height: 20px; }
    .nav-badge { margin-left: auto; background: var(--accent); color: var(--bg-dark); font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px; }
    .sidebar-footer { margin-top: auto; padding: 24px; border-top: 1px solid rgba(255,255,255,0.1); }
    .user-info { margin-bottom: 16px; }
    .user-info .name { font-size: 13px; font-weight: 600; color: #fff; }
    .user-info .email { font-size: 11px; color: rgba(255,255,255,0.5); }
    .logout-btn { width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: none; border-radius: var(--radius-md); color: rgba(255,255,255,0.7); font-size: 13px; cursor: pointer; font-family: inherit; }
    .logout-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }

    .main { margin-left: 260px; min-height: 100vh; }
    .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 20px 32px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
    .header h2 { font-size: 22px; font-weight: 700; }
    .header p { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .header-actions { display: flex; gap: 12px; }
    .content { padding: 32px; }

    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 24px; border: 1px solid var(--border-light); box-shadow: var(--shadow-sm); }
    .stat-card.highlight { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border: none; }
    .stat-card.highlight .stat-label, .stat-card.highlight .stat-value { color: #fff; }
    .stat-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
    .stat-value { font-size: 28px; font-weight: 700; font-family: 'Space Mono', monospace; }

    .card { background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-light); box-shadow: var(--shadow-sm); overflow: hidden; }
    .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border-light); }
    .card-header h3 { font-size: 16px; font-weight: 600; }
    .card-body { padding: 24px; }
    .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 24px; }

    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 14px 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); font-weight: 600; background: var(--bg-main); border-bottom: 1px solid var(--border); }
    td { padding: 16px; font-size: 14px; border-bottom: 1px solid var(--border-light); }
    tr:hover { background: var(--bg-main); }
    .customer-cell { display: flex; align-items: center; gap: 12px; }
    .customer-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; }
    .customer-info .name { font-weight: 600; }
    .customer-info .id { font-size: 12px; color: var(--text-muted); font-family: 'Space Mono', monospace; }
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-badge.received { background: var(--success-light); color: var(--success); }
    .status-badge.staging { background: var(--warning-light); color: #856404; }
    .weight-cell { font-family: 'Space Mono', monospace; font-weight: 600; }
    .value-cell { font-family: 'Space Mono', monospace; color: var(--success); font-weight: 600; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(13,31,26,0.6); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg-card); border-radius: var(--radius-lg); width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; box-shadow: var(--shadow-lg); }
    .modal-header { padding: 24px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; justify-content: space-between; }
    .modal-header h3 { font-size: 18px; font-weight: 700; }
    .modal-close { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--bg-main); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: var(--danger-light); color: var(--danger); }
    .modal-body { padding: 24px; overflow-y: auto; max-height: calc(90vh - 160px); }
    .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border-light); display: flex; justify-content: flex-end; gap: 12px; background: var(--bg-main); }
    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .form-group.full-width { grid-column: span 2; }
    .form-label .required { color: var(--danger); }
    textarea.form-input { resize: vertical; min-height: 80px; }
    .section-divider { display: flex; align-items: center; gap: 16px; margin: 24px 0; }
    .section-divider span { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
    .section-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

    .totals-row { display: flex; justify-content: flex-end; gap: 32px; padding: 20px 24px; background: var(--bg-main); border-top: 2px solid var(--border); }
    .total-item { text-align: right; }
    .total-item label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; }
    .total-item .value { font-size: 20px; font-weight: 700; font-family: 'Space Mono', monospace; }
    .total-item .value.primary { color: var(--primary); }

    .page { display: none; }
    .page.active { display: block; }
    .filters { display: flex; gap: 12px; margin-bottom: 20px; }
    .filter-select { padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 13px; font-family: inherit; background: var(--bg-card); }

    .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .loading-overlay .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); }
    .loading-overlay.hidden { display: none; }

    @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .grid-2 { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .main { margin-left: 0; } .stats-grid { grid-template-columns: 1fr; } .form-grid { grid-template-columns: 1fr; } .form-group.full-width { grid-column: span 1; } }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

  <div class="login-screen" id="loginScreen">
    <div class="login-container">
      <div class="login-header">
        <h1>GC<span>S</span></h1>
        <h1>Guinea Cargo Services</h1>
        <p>Operations Portal</p>
      </div>
      <div class="login-body">
        <div class="login-tabs">
          <button class="login-tab active" onclick="showLoginTab('signin')">Sign In</button>
          <button class="login-tab" onclick="showLoginTab('signup')">Sign Up</button>
        </div>
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        <form id="signinForm" onsubmit="handleSignIn(event)">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="signinEmail" placeholder="Enter your email" required>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" id="signinPassword" placeholder="Enter password" required>
          </div>
          <button type="submit" class="btn btn-primary" id="signinBtn">Sign In</button>
        </form>
        <form id="signupForm" style="display:none;" onsubmit="handleSignUp(event)">
          <div class="form-group">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-input" id="signupName" placeholder="Your name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="signupEmail" placeholder="Enter your email" required>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" id="signupPassword" placeholder="Min 6 characters" minlength="6" required>
          </div>
          <button type="submit" class="btn btn-primary" id="signupBtn">Create Account</button>
        </form>
        <p style="text-align:center;margin-top:24px;font-size:13px;color:var(--text-muted);">Guinea Cargo Services 2026</p>
      </div>
    </div>
  </div>

  <div class="app-container" id="appContainer">
    <aside class="sidebar">
      <div class="logo">
        <h1>GC<span>S</span></h1>
        <p>Operations Portal</p>
      </div>
      <nav class="nav-section">
        <div class="nav-section-title">Main Menu</div>
        <a class="nav-item active" data-page="dashboard">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6z"/></svg>
          Dashboard
        </a>
        <a class="nav-item" data-page="customers">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          Customers
          <span class="nav-badge" id="customerCount">0</span>
        </a>
        <a class="nav-item" data-page="inventory">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
          Inventory
          <span class="nav-badge" id="inventoryCount">0</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="name" id="userName">User</div>
          <div class="email" id="userEmail">-</div>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
      </div>
    </aside>

    <main class="main">
      <div class="page active" id="dashboard">
        <header class="header">
          <div>
            <h2>Dashboard</h2>
            <p>Welcome to Guinea Cargo Services</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="openModal('customerModal')">New Customer</button>
            <button class="btn btn-primary" onclick="openModal('itemModal')">Add Items</button>
          </div>
        </header>
        <div class="content">
          <div class="stats-grid">
            <div class="stat-card highlight">
              <div class="stat-label">Total Weight</div>
              <div class="stat-value" id="statWeight">0 lbs</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Customers</div>
              <div class="stat-value" id="statCustomers">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Value</div>
              <div class="stat-value" id="statValue">$0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Items</div>
              <div class="stat-value" id="statItems">0</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Recent Customers</h3></div>
            <table>
              <thead><tr><th>Customer</th><th>Items</th><th>Weight</th><th>Value</th><th>Status</th></tr></thead>
              <tbody id="dashboardTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="page" id="customers">
        <header class="header">
          <div>
            <h2>Customers</h2>
            <p>Manage customer database</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="openModal('customerModal')">Add Customer</button>
          </div>
        </header>
        <div class="content">
          <div class="card">
            <table>
              <thead><tr><th>Customer</th><th>Phone</th><th>Recipient</th><th>Items</th><th>Weight</th><th>Value</th></tr></thead>
              <tbody id="customersTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="page" id="inventory">
        <header class="header">
          <div>
            <h2>Inventory</h2>
            <p>Track items for shipment</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
            <button class="btn btn-primary" onclick="openModal('itemModal')">Add Items</button>
          </div>
        </header>
        <div class="content">
          <div class="filters">
            <select class="filter-select" id="filterCustomer" onchange="renderInventory()"><option value="">All Customers</option></select>
            <select class="filter-select" id="filterCategory" onchange="renderInventory()">
              <option value="">All Categories</option>
              <option value="electronics">Electronics</option>
              <option value="clothing">Clothing</option>
              <option value="appliances">Appliances</option>
              <option value="household">Household</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="card">
            <table>
              <thead><tr><th>ID</th><th>Customer</th><th>Description</th><th>Category</th><th>Weight</th><th>Value</th></tr></thead>
              <tbody id="inventoryTable"></tbody>
            </table>
            <div class="totals-row">
              <div class="total-item"><label>Items</label><div class="value" id="totalItems">0</div></div>
              <div class="total-item"><label>Weight</label><div class="value" id="totalWeight">0 lbs</div></div>
              <div class="total-item"><label>Value</label><div class="value primary" id="totalValue">$0</div></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal-overlay" id="customerModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Add Customer</h3>
        <button class="modal-close" onclick="closeModal('customerModal')">X</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">First Name <span class="required">*</span></label><input type="text" class="form-input" id="custFirstName"></div>
          <div class="form-group"><label class="form-label">Last Name <span class="required">*</span></label><input type="text" class="form-input" id="custLastName"></div>
          <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="custPhone"></div>
          <div class="form-group"><label class="form-label">City</label><input type="text" class="form-input" id="custCity"></div>
        </div>
        <div class="section-divider"><span>Recipient in Guinea</span></div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Recipient Name <span class="required">*</span></label><input type="text" class="form-input" id="recipientName"></div>
          <div class="form-group"><label class="form-label">Recipient Phone</label><input type="text" class="form-input" id="recipientPhone"></div>
          <div class="form-group full-width"><label class="form-label">Delivery Address <span class="required">*</span></label><textarea class="form-input" id="recipientAddress"></textarea></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('customerModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCustomer()">Save</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="itemModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Add Item</h3>
        <button class="modal-close" onclick="closeModal('itemModal')">X</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full-width"><label class="form-label">Customer <span class="required">*</span></label><select class="form-input" id="itemCustomer"></select></div>
          <div class="form-group full-width"><label class="form-label">Description <span class="required">*</span></label><input type="text" class="form-input" id="itemDesc"></div>
          <div class="form-group"><label class="form-label">Category</label>
            <select class="form-input" id="itemCategory">
              <option value="electronics">Electronics</option>
              <option value="clothing">Clothing</option>
              <option value="appliances">Appliances</option>
              <option value="household">Household</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Weight (lbs)</label><input type="number" class="form-input" id="itemWeight" value="0"></div>
          <div class="form-group"><label class="form-label">Value ($)</label><input type="number" class="form-input" id="itemValue" value="0"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('itemModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveItem()">Save</button>
      </div>
    </div>
  </div>

  <script>
    var SUPABASE_URL = 'https://usxkawrvasiidlsludjc.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzeGthd3J2YXNpaWRsc2x1ZGpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Nzg5MjMsImV4cCI6MjA4NTE1NDkyM30.AAkyRqAywxkXv3aO0uNIf7RuG1lCxrcS89wHJKqlunQ';

    var sb = null;
    var currentUser = null;
    var customers = [];
    var inventory = [];

    function initApp() {
      if (typeof window.supabase !== 'undefined') {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        sb.auth.getSession().then(function(res) {
          if (res.data.session) {
            currentUser = res.data.session.user;
            showApp();
            loadData();
          } else {
            hideLoading();
          }
        });
        sb.auth.onAuthStateChange(function(event, session) {
          if (event === 'SIGNED_IN' && session) {
            currentUser = session.user;
            showApp();
            loadData();
          } else if (event === 'SIGNED_OUT') {
            currentUser = null;
            hideApp();
          }
        });
      } else {
        hideLoading();
        alert('Could not load Supabase library. Please refresh the page.');
      }
    }

    function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
    function showApp() {
      hideLoading();
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('appContainer').classList.add('show');
      if (currentUser) {
        var name = (currentUser.user_metadata && currentUser.user_metadata.full_name) || 'User';
        document.getElementById('userName').textContent = name;
        document.getElementById('userEmail').textContent = currentUser.email || '-';
      }
    }
    function hideApp() {
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('appContainer').classList.remove('show');
    }

    function showLoginTab(tab) {
      document.querySelectorAll('.login-tab').forEach(function(t) { t.classList.remove('active'); });
      event.target.classList.add('active');
      document.getElementById('signinForm').style.display = tab === 'signin' ? 'block' : 'none';
      document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
      document.getElementById('errorMessage').classList.remove('show');
      document.getElementById('successMessage').classList.remove('show');
    }

    function showError(msg) {
      document.getElementById('errorMessage').textContent = msg;
      document.getElementById('errorMessage').classList.add('show');
      document.getElementById('successMessage').classList.remove('show');
    }
    function showSuccess(msg) {
      document.getElementById('successMessage').textContent = msg;
      document.getElementById('successMessage').classList.add('show');
      document.getElementById('errorMessage').classList.remove('show');
    }

    function handleSignIn(e) {
      e.preventDefault();
      var email = document.getElementById('signinEmail').value;
      var password = document.getElementById('signinPassword').value;
      var btn = document.getElementById('signinBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';
      sb.auth.signInWithPassword({ email: email, password: password }).then(function(res) {
        btn.disabled = false;
        btn.textContent = 'Sign In';
        if (res.error) showError(res.error.message);
      });
    }

    function handleSignUp(e) {
      e.preventDefault();
      var name = document.getElementById('signupName').value;
      var email = document.getElementById('signupEmail').value;
      var password = document.getElementById('signupPassword').value;
      var btn = document.getElementById('signupBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';
      sb.auth.signUp({ email: email, password: password, options: { data: { full_name: name } } }).then(function(res) {
        btn.disabled = false;
        btn.textContent = 'Create Account';
        if (res.error) {
          showError(res.error.message);
        } else {
          showSuccess('Account created! Check your email to confirm, then sign in.');
        }
      });
    }

    function handleLogout() {
      sb.auth.signOut();
      customers = [];
      inventory = [];
      hideApp();
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    function loadData() {
      sb.from('customers').select('*').order('created_at', { ascending: false }).then(function(res) {
        customers = res.data || [];
        renderAll();
      });
      sb.from('inventory').select('*').order('created_at', { ascending: false }).then(function(res) {
        inventory = res.data || [];
        renderAll();
      });
    }

    function saveCustomer() {
      var c = {
        customer_id: 'GCS-' + Date.now(),
        first_name: document.getElementById('custFirstName').value,
        last_name: document.getElementById('custLastName').value,
        phone: document.getElementById('custPhone').value,
        city: document.getElementById('custCity').value,
        recipient_name: document.getElementById('recipientName').value,
        recipient_phone: document.getElementById('recipientPhone').value,
        recipient_address: document.getElementById('recipientAddress').value,
        user_id: currentUser.id
      };
      if (!c.first_name || !c.last_name || !c.phone || !c.recipient_name || !c.recipient_address) {
        alert('Please fill required fields'); return;
      }
      sb.from('customers').insert([c]).select().then(function(res) {
        if (res.error) { alert(res.error.message); return; }
        customers.unshift(res.data[0]);
        closeModal('customerModal');
        clearCustomerForm();
        renderAll();
      });
    }

    function saveItem() {
      var custId = document.getElementById('itemCustomer').value;
      if (!custId) { alert('Select a customer'); return; }
      var item = {
        item_id: 'INV-' + Date.now(),
        customer_id: custId,
        description: document.getElementById('itemDesc').value,
        category: document.getElementById('itemCategory').value,
        weight: parseFloat(document.getElementById('itemWeight').value) || 0,
        value: parseFloat(document.getElementById('itemValue').value) || 0,
        status: 'received',
        user_id: currentUser.id
      };
      if (!item.description) { alert('Enter description'); return; }
      sb.from('inventory').insert([item]).select().then(function(res) {
        if (res.error) { alert(res.error.message); return; }
        inventory.unshift(res.data[0]);
        closeModal('itemModal');
        clearItemForm();
        renderAll();
      });
    }

    function clearCustomerForm() {
      ['custFirstName','custLastName','custPhone','custCity','recipientName','recipientPhone','recipientAddress'].forEach(function(id) {
        document.getElementById(id).value = '';
      });
    }
    function clearItemForm() {
      document.getElementById('itemDesc').value = '';
      document.getElementById('itemWeight').value = '0';
      document.getElementById('itemValue').value = '0';
    }

    function getStats() {
      var stats = {};
      inventory.forEach(function(i) {
        if (!stats[i.customer_id]) stats[i.customer_id] = { items: 0, weight: 0, value: 0 };
        stats[i.customer_id].items++;
        stats[i.customer_id].weight += i.weight || 0;
        stats[i.customer_id].value += i.value || 0;
      });
      return stats;
    }

    function renderAll() {
      var stats = getStats();
      var totalW = 0, totalV = 0;
      inventory.forEach(function(i) { totalW += i.weight || 0; totalV += i.value || 0; });

      document.getElementById('statWeight').textContent = totalW + ' lbs';
      document.getElementById('statCustomers').textContent = customers.length;
      document.getElementById('statValue').textContent = '$' + totalV.toLocaleString();
      document.getElementById('statItems').textContent = inventory.length;
      document.getElementById('customerCount').textContent = customers.length;
      document.getElementById('inventoryCount').textContent = inventory.length;

      var dashHtml = '';
      customers.slice(0, 5).forEach(function(c) {
        var s = stats[c.customer_id] || { items: 0, weight: 0, value: 0 };
        dashHtml += '<tr><td><div class="customer-cell"><div class="customer-avatar">' + c.first_name[0] + c.last_name[0] + '</div><div class="customer-info"><div class="name">' + c.first_name + ' ' + c.last_name + '</div><div class="id">' + c.customer_id + '</div></div></div></td><td>' + s.items + '</td><td class="weight-cell">' + s.weight + ' lbs</td><td class="value-cell">$' + s.value.toLocaleString() + '</td><td><span class="status-badge received">Received</span></td></tr>';
      });
      document.getElementById('dashboardTable').innerHTML = dashHtml || '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted)">No customers yet</td></tr>';

      var custHtml = '';
      customers.forEach(function(c) {
        var s = stats[c.customer_id] || { items: 0, weight: 0, value: 0 };
        custHtml += '<tr><td><div class="customer-cell"><div class="customer-avatar">' + c.first_name[0] + c.last_name[0] + '</div><div class="customer-info"><div class="name">' + c.first_name + ' ' + c.last_name + '</div><div class="id">' + c.customer_id + '</div></div></div></td><td>' + c.phone + '</td><td>' + c.recipient_name + '</td><td>' + s.items + '</td><td class="weight-cell">' + s.weight + ' lbs</td><td class="value-cell">$' + s.value.toLocaleString() + '</td></tr>';
      });
      document.getElementById('customersTable').innerHTML = custHtml || '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted)">No customers yet</td></tr>';

      populateDropdowns();
      renderInventory();
    }

    function renderInventory() {
      var filterCust = document.getElementById('filterCustomer').value;
      var filterCat = document.getElementById('filterCategory').value;
      var filtered = inventory.filter(function(i) {
        if (filterCust && i.customer_id !== filterCust) return false;
        if (filterCat && i.category !== filterCat) return false;
        return true;
      });
      var invHtml = '';
      var tW = 0, tV = 0;
      filtered.forEach(function(i) {
        var c = customers.find(function(cu) { return cu.customer_id === i.customer_id; });
        var cName = c ? c.first_name + ' ' + c.last_name : i.customer_id;
        invHtml += '<tr><td style="font-family:Space Mono,monospace;font-size:12px">' + i.item_id + '</td><td>' + cName + '</td><td>' + i.description + '</td><td style="text-transform:capitalize">' + i.category + '</td><td class="weight-cell">' + i.weight + ' lbs</td><td class="value-cell">$' + (i.value || 0).toLocaleString() + '</td></tr>';
        tW += i.weight || 0;
        tV += i.value || 0;
      });
      document.getElementById('inventoryTable').innerHTML = invHtml || '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted)">No items yet</td></tr>';
      document.getElementById('totalItems').textContent = filtered.length;
      document.getElementById('totalWeight').textContent = tW + ' lbs';
      document.getElementById('totalValue').textContent = '$' + tV.toLocaleString();
    }

    function populateDropdowns() {
      var opts = '<option value="">Select customer...</option>';
      customers.forEach(function(c) {
        opts += '<option value="' + c.customer_id + '">' + c.first_name + ' ' + c.last_name + '</option>';
      });
      document.getElementById('itemCustomer').innerHTML = opts;
      document.getElementById('filterCustomer').innerHTML = '<option value="">All Customers</option>' + opts.replace('Select customer...', 'All Customers');
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); populateDropdowns(); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    document.querySelectorAll('.nav-item').forEach(function(item) {
      item.addEventListener('click', function() {
        var page = this.getAttribute('data-page');
        if (!page) return;
        document.querySelectorAll('.nav-item').forEach(function(i) { i.classList.remove('active'); });
        this.classList.add('active');
        document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
        document.getElementById(page).classList.add('active');
      });
    });

    document.querySelectorAll('.modal-overlay').forEach(function(m) {
      m.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('active'); });
    });

    function exportCSV() {
      var csv = 'ID,Customer,Description,Category,Weight,Value\n';
      inventory.forEach(function(i) {
        csv += i.item_id + ',' + i.customer_id + ',"' + i.description + '",' + i.category + ',' + i.weight + ',' + i.value + '\n';
      });
      var blob = new Blob([csv], { type: 'text/csv' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'inventory.csv';
      a.click();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
